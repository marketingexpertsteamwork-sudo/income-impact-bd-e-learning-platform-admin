<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Income Impact BD</title>
    <link rel="icon" href="https://img.icons8.com/fluency/48/000000/source-code.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db; --secondary-color: #f5f7fa; --sidebar-bg: #2c3e50; --text-color: #333; --light-text-color: #ecf0f1; --border-color: #dfe3e8; --success-color: #2ecc71; --danger-color: #e74c3c; --warning-color: #f39c12; --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: var(--secondary-color); display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 250px; background-color: var(--sidebar-bg); color: var(--light-text-color); display: flex; flex-direction: column; flex-shrink: 0; transition: margin-left 0.3s ease; overflow-y: auto; }
        .sidebar-header { text-align: center; padding: 20px; border-bottom: 1px solid #34495e; }
        .sidebar-header h2 { margin: 0; font-size: 1.8rem; font-weight: 700; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 20px 0; }
        .sidebar nav ul li a { display: block; padding: 15px 25px; color: var(--light-text-color); text-decoration: none; transition: background-color 0.3s, border-left 0.3s; font-size: 1.1rem; border-left: 4px solid transparent; }
        .sidebar nav ul li a:hover { background-color: #34495e; }
        .sidebar nav ul li a.active { background-color: #34495e; border-left: 4px solid var(--primary-color); font-weight: bold; }
        .main-content { flex-grow: 1; padding: 25px; overflow-y: auto; position: relative; }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page-header { margin-bottom: 25px; }
        .page-header h1 { margin: 0; font-size: 2.2rem; color: var(--text-color); font-weight: 700; }
        .menu-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 1001; background: var(--sidebar-bg); color: white; border: none; padding: 10px 12px; border-radius: 5px; cursor: pointer; }
        .menu-toggle .bar { display: block; width: 22px; height: 3px; background-color: white; margin: 4px 0; transition: 0.3s; }
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: var(--shadow); border-left: 5px solid var(--primary-color); }
        .card.success { border-color: var(--success-color); } .card.danger { border-color: var(--danger-color); } .card.warning { border-color: var(--warning-color); }
        .card h3 { margin-top: 0; font-size: 1.1rem; color: #777; }
        .card .value { font-size: 2.2rem; font-weight: bold; color: var(--text-color); }
        .card .value.small { font-size: 1.5rem; }
        .chart-container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .table-container { background-color: #fff; border-radius: 8px; box-shadow: var(--shadow); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        td.message-col, td.review-col { white-space: normal; min-width: 300px; }
        th { background-color: #f9fafb; font-weight: 600; }
        .status { padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; font-weight: bold; color: #fff; }
        .status.active, .status.published, .status.Approved, .status.processed { background-color: var(--success-color); } 
        .status.blocked, .status.Rejected, .status.rejected { background-color: var(--danger-color); } 
        .status.pending, .status.Pending, .status.inactive, .status.submitted { background-color: var(--warning-color); } 
        .status.resolved, .status.correction_needed { background-color: var(--primary-color); }
        .action-btn { border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; color: #fff; margin: 2px; font-size: 0.9rem; }
        .edit-btn { background-color: var(--primary-color); } .delete-btn { background-color: var(--danger-color); } .content-btn { background-color: #9b59b6; } .progress-btn { background-color: var(--warning-color); } .enroll-btn { background-color: #16a085; }
        .settings-card { background-color: #fff; padding: 30px 25px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 25px; }
        .settings-card .form-group { margin-bottom: 25px; }
        .settings-card .form-group label { display: block; margin-bottom: 10px; font-weight: 600; font-size: 1.1rem; color: var(--text-color); }
        .settings-card .form-group input, .settings-card .form-group textarea, .settings-card .form-group select { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .settings-card .submit-btn, .settings-card .form-btn { width: auto; min-width: 150px; padding: 15px; background-color: var(--primary-color); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: bold; margin-top: 10px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: #fff; padding: 30px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .close-btn { cursor: pointer; font-size: 1.5rem; color: #aaa; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; box-sizing: border-box; }
        .submit-btn { width: 100%; padding: 15px; background-color: var(--primary-color); color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1rem; font-weight: bold; }
        .add-new-btn { background-color: var(--success-color); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-bottom: 20px; }
        .grid-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3-col { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .module { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; padding: 15px; }
        .module-header { font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .lesson { border-top: 1px solid #eee; padding: 10px 0; }
        .lesson:first-child { border-top: none; }
        .filter-controls, .bulk-action-controls { display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: var(--shadow); }
        .filter-controls input, .filter-controls select, .bulk-action-controls select, .bulk-action-controls button { padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1rem; }
        .filter-controls input { flex-grow: 1; }
        .pagination-controls { display: flex; justify-content: flex-end; align-items: center; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: var(--shadow); margin-top: 20px; }
        .pagination-controls button { background-color: var(--primary-color); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 0 5px; }
        .pagination-controls button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        
        /* NEW STYLES FOR PERMISSIONS */
        .permissions-fieldset { border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; margin-top: 20px; }
        .permissions-fieldset legend { font-weight: 600; padding: 0 10px; }
        .permissions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .permission-item { display: flex; align-items: center; }
        .permission-item input { width: auto; margin-right: 8px; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: 0; height: 100%; z-index: 1000; margin-left: -250px; } .sidebar.show { margin-left: 0; }
            .main-content { padding: 20px; padding-top: 70px; } .menu-toggle { display: block; } .page-header h1 { font-size: 1.8rem; }
            .grid-2-col, .grid-3-col { grid-template-columns: 1fr; }
            .filter-controls, .bulk-action-controls { flex-direction: column; }
        }
    </style>
</head>
<body>
    
    <div id="login-screen" style="width: 100%; height: 100vh; display: flex; justify-content: center; align-items: center; flex-direction: column; background-color: var(--sidebar-bg);">
        <h1 style="color: white; margin-bottom: 20px;">অ্যাডমিন প্যানেল</h1>
        <button id="login-btn" style="padding: 15px 30px; font-size: 1.2rem; cursor: pointer; border: none; border-radius: 8px; background-color: var(--primary-color); color: white;">প্রবেশ করুন</button>
    </div>

    <div id="app-container" style="display: none; width: 100%; height: 100vh;">
        <button class="menu-toggle" id="menuToggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header"><h2>Admin<br>Panel</h2></div>
            <nav>
                <ul>
                    <li><a href="#dashboard" class="nav-link active">ড্যাশবোর্ড</a></li>
                    <li><a href="#analytics" class="nav-link">বিস্তারিত অ্যানালিটিক্স</a></li>
                    <li><a href="#user-management" class="nav-link">ব্যবহারকারী ম্যানেজমেন্ট</a></li>
                    <li><a href="#course-management" class="nav-link">কোর্স ম্যানেজমেন্ট</a></li>
                    <li><a href="#category-management" class="nav-link">কোর্স ক্যাটাগরি</a></li>
                    <li><a href="#homework-review" class="nav-link">হোমওয়ার্ক রিভিউ</a></li>
                    <li><a href="#withdrawal-requests" class="nav-link">উইথড্র রিকুয়েস্ট</a></li>
                    <li><a href="#coupon-management" class="nav-link">কুপন ম্যানেজমেন্ট</a></li>
                    <li><a href="#liveclass-management" class="nav-link">লাইভ ক্লাস ম্যানেজমেন্ট</a></li>
                    <li><a href="#certificate-management" class="nav-link">সার্টিফিকেট ম্যানেজমেন্ট</a></li>
                    <li><a href="#notifications" class="nav-link">বিজ্ঞপ্তি পাঠান</a></li>
                    <li><a href="#group-messaging" class="nav-link">গ্রুপ মেসেজিং</a></li>
                    <li><a href="#qna-management" class="nav-link">প্রশ্নোত্তর ম্যানেজমেন্ট</a></li>
                    <li><a href="#course-reviews" class="nav-link">কোর্স রিভিউ</a></li>
                    <li><a href="#community-management" class="nav-link">কমিউনিটি ম্যানেজমেন্ট</a></li>
                    <li><a href="#payment-history" class="nav-link">পেমেন্ট হিস্ট্রি</a></li>
                    <li><a href="#support-tickets" class="nav-link">সাপোর্ট টিকেট</a></li>
                    <li><a href="#earnings" class="nav-link">আর্নিং রিপোর্ট</a></li>
                    <li><a href="#project-management" class="nav-link">প্রজেক্ট ম্যানেজমেন্ট</a></li>
                    <li><a href="#workshop-management" class="nav-link">ওয়ার্কশপ ম্যানেজমেন্ট</a></li>
                    <li><a href="#blog-management" class="nav-link">ব্লগ/নোটিশ</a></li>
                    <li><a href="#contact-messages" class="nav-link">যোগাযোগ বার্তা</a></li>
                    <li><a href="#page-content" class="nav-link">পেজ কনটেন্ট</a></li>
                    <li><a href="#text-seo-management" class="nav-link">টেক্সট ও SEO</a></li>
                    <li><a href="#menu-management" class="nav-link">ন্যাভিগেশন মেনু</a></li>
                    <li><a href="#role-management" class="nav-link">সাব-অ্যাডমিন রোল</a></li>
                    <li><a href="#mentor-management" class="nav-link">মেন্টর ম্যানেজমেন্ট</a></li>
                    <li><a href="#referral-management" class="nav-link">রেফারেল ম্যানেজমেন্ট</a></li>
                    <li><a href="#balance-logs" class="nav-link">ব্যালেন্স লগ</a></li>
                    <li><a href="#country-code-management" class="nav-link">কান্ট্রি কোড</a></li>
                    <li><a href="#activity-logs" class="nav-link">অ্যাডমিন লগ</a></li>
                    <li><a href="#footer-management" class="nav-link">ফুটার ম্যানেজমেন্ট</a></li>
                    <li><a href="#gamification-settings" class="nav-link">গ্যামিফিকেশন সেটিংস</a></li>
                    <li><a href="#settings" class="nav-link">সেটিংস ও থিম</a></li>
                    <li><a href="#" id="logout-btn" class="nav-link" style="color: var(--danger-color);">লগআউট</a></li>
                </ul>
            </nav>
        </aside>
        <main class="main-content">
            <section id="dashboard" class="content-section active">
                <div class="page-header"><h1>ড্যাশবোর্ড</h1></div>
                <div class="dashboard-cards">
                    <div class="card"><h3>মোট ব্যবহারকারী</h3><p class="value" id="totalUsers">0</p></div>
                    <div class="card success"><h3>মোট কোর্স</h3><p class="value" id="totalCourses">0</p></div>
                    <div class="card warning"><h3>মোট আয় (BDT)</h3><p class="value" id="totalEarnings">0</p></div>
                    <div class="card danger"><h3>অ্যাক্টিভ শিক্ষার্থী</h3><p class="value" id="activeStudents">0</p></div>
                    <div class="card"><h3>সবচেয়ে জনপ্রিয় কোর্স</h3><p class="value small" id="popularCourse">N/A</p></div>
                    <div class="card success"><h3>গড় কোর্স সমাপ্তির হার</h3><p class="value" id="completionRate">0%</p></div>
                </div>
                <div class="chart-container"><canvas id="userGrowthChart"></canvas></div>
            </section>

            <section id="analytics" class="content-section">
                <div class="page-header"><h1>বিস্তারিত অ্যানালিটিক্স</h1></div>
                 <div class="dashboard-cards">
                    <div class="card warning"><h3>এই মাসের আয় (BDT)</h3><p class="value" id="monthlyEarnings">0</p></div>
                    <div class="card success"><h3>এই মাসে নতুন ব্যবহারকারী</h3><p class="value" id="monthlyNewUsers">0</p></div>
                    <div class="card"><h3>সর্বোচ্চ রেফারকারী</h3><p class="value small" id="topReferrer">N/A</p></div>
                    <div class="card danger"><h3>গড় কোর্স সমাপ্তির হার</h3><p class="value" id="avgCompletionRateAnalytics">0%</p></div>
                    <!-- NEW ANALYTICS CARDS START -->
                    <div class="card"><h3>অ্যাক্টিভ / পেন্ডিং ইউজার</h3><p class="value" id="activePendingUsers">0 / 0</p></div>
                    <div class="card success"><h3>টপ ইউজার কান্ট্রি</h3><p class="value small" id="topUserCountry">N/A</p></div>
                    <!-- NEW ANALYTICS CARDS END -->
                </div>
                <div class="chart-container">
                    <h3>মাসিক আয় (গত ৬ মাস)</h3>
                    <canvas id="monthlyRevenueChart"></canvas>
                </div>
                <div class="settings-card" style="margin-top: 20px;">
                    <h3>কোর্স অনুযায়ী আয় ও এনরোলমেন্ট</h3>
                    <div class="table-container">
                        <table id="courseAnalyticsTable">
                            <thead><tr><th>কোর্সের নাম</th><th>মোট এনরোলমেন্ট</th><th>মোট আয় (BDT)</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="user-management" class="content-section">
                <div class="page-header"><h1>ব্যবহারকারী ম্যানেজমেন্ট</h1></div>
                <button class="add-new-btn" onclick="openCreateUserModal()">নতুন ইউজার তৈরি করুন</button>
                <div class="filter-controls">
                    <input type="text" id="userSearchInput" placeholder="নাম বা ইমেইল দিয়ে সার্চ করুন...">
                    <select id="userStatusFilter">
                        <option value="all">সকল স্ট্যাটাস</option>
                        <option value="active">Active</option>
                        <option value="pending">Pending</option>
                        <option value="blocked">Blocked</option>
                    </select>
                </div>
                <div class="bulk-action-controls">
                    <select id="bulkActionSelect">
                        <option value="">বাল্ক অ্যাকশন...</option>
                        <option value="activate">নির্বাচিতদের সক্রিয় করুন</option>
                        <option value="block">নির্বাচিতদের ব্লক করুন</option>
                        <option value="delete">নির্বাচিতদের মুছুন</option>
                    </select>
                    <button id="applyBulkActionButton">প্রয়োগ করুন</button>
                </div>
                <div class="table-container">
                    <table><thead><tr><th><input type="checkbox" id="selectAllUsersCheckbox"></th><th>প্রোফাইল ছবি</th><th>নাম</th><th>ইমেইল</th><th>ব্যালেন্স (BDT)</th><th>স্ট্যাটাস</th><th>অ্যাকশন</th></tr></thead><tbody id="userTableBody"></tbody></table>
                </div>
                <div class="pagination-controls" id="userPaginationControls"></div>
            </section>
            <section id="course-management" class="content-section">
                <div class="page-header"><h1>কোর্স ম্যানেজমেন্ট</h1></div><button class="add-new-btn" onclick="openCourseModal()">নতুন কোর্স যোগ করুন</button>
                <div class="table-container">
                    <!-- NEW 'Order' COLUMN ADDED -->
                    <table><thead><tr><th>কোর্সের নাম</th><th>ক্যাটাগরি</th><th>মূল্য (BDT)</th><th>হোমওয়ার্ক রিওয়ার্ড</th><th>Order</th><th>স্ট্যাটাস</th><th>অ্যাকশন</th></tr></thead><tbody id="courseTableBody"></tbody></table>
                </div>
                <div class="pagination-controls" id="coursePaginationControls"></div>
            </section>

            <section id="category-management" class="content-section">
                <div class="page-header"><h1>কোর্স ক্যাটাগরি ম্যানেজমেন্ট</h1></div>
                <button class="add-new-btn" onclick="openCategoryModal()">নতুন ক্যাটাগরি যোগ করুন</button>
                <div class="table-container">
                    <table>
                        <thead><tr><th>ক্যাটাগরির নাম</th><th>অ্যাকশন</th></tr></thead>
                        <tbody id="categoryTableBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="homework-review" class="content-section">
                <div class="page-header"><h1>হোমওয়ার্ক রিভিউ</h1></div>
                <button class="add-new-btn" onclick="openHomeworkModal()">ম্যানুয়াল হোমওয়ার্ক যোগ করুন</button>
                <div class="table-container">
                    <table>
                        <thead><tr><th>ছাত্রের নাম</th><th>কোর্সের নাম</th><th>হোমওয়ার্ক লিংক</th><th>জমা দেওয়ার তারিখ</th><th>স্ট্যাটাস</th><th>অ্যাকশন</th></tr></thead>
                        <tbody id="homeworkReviewTableBody"></tbody>
                    </table>
                </div>
                <div class="pagination-controls" id="homeworkPaginationControls"></div>
            </section>

            <section id="withdrawal-requests" class="content-section">
                <div class="page-header"><h1>উইথড্র রিকুয়েস্ট</h1></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>ব্যবহারকারী</th><th>টাকার পরিমাণ (BDT)</th><th>পেমেন্ট মেথড</th><th>অ্যাকাউন্ট বিবরণ</th><th>রিকুয়েস্টের তারিখ</th><th>স্ট্যাটাস</th><th>অ্যাকশন</th></tr></thead>
                        <tbody id="withdrawalRequestsTableBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="coupon-management" class="content-section">
                <div class="page-header"><h1>কুপন ম্যানেজমেন্ট</h1></div>
                <button class="add-new-btn" onclick="openCouponModal()">নতুন কুপন যোগ করুন</button>
                <div class="table-container">
                    <table>
                        <thead><tr><th>কুপন কোড</th><th>ধরন</th><th>مقدار</th><th>মেয়াদ শেষ</th><th>অ্যাকশন</th></tr></thead>
                        <tbody id="couponTableBody"></tbody>
                    </table>
                </div>
            </section>
            <section id="liveclass-management" class="content-section">
                <div class="page-header"><h1>লাইভ ক্লাস ম্যানেজমেন্ট</h1></div>
                <div class="settings-card">
                    <form id="liveClassForm">
                        <h3>নতুন লাইভ ক্লাস তৈরি করুন</h3>
                        <div class="form-group"><label for="liveClassTitle">ক্লাসের শিরোনাম</label><input type="text" id="liveClassTitle" required></div>
                        <div class="form-group"><label for="liveClassTeacher">শিক্ষকের নাম</label><input type="text" id="liveClassTeacher" placeholder="e.g., John Doe"></div>
                        <div class="form-group"><label for="liveClassUrl">মিটিং URL (Zoom/Meet)</label><input type="url" id="liveClassUrl" required></div>
                        <div class="form-group"><label for="liveClassDateTime">তারিখ ও সময়</label><input type="datetime-local" id="liveClassDateTime" required></div>
                        <div class="form-group"><label for="liveClassDesc">সংক্ষিপ্ত বিবরণ</label><textarea id="liveClassDesc" rows="3" placeholder="লাইভ ক্লাসের বিবরণ এবং প্রাসঙ্গিক WhatsApp গ্রুপের তথ্য দিন।"></textarea></div>
                        <button type="submit" class="submit-btn">ক্লাস যুক্ত করুন</button>
                    </form>
                </div>
                 <div class="table-container" style="margin-top: 30px;">
                    <h3>পূর্ববর্তী লাইভ ক্লাসসমূহ</h3>
                    <table><thead><tr><th>শিরোনাম</th><th>শিক্ষক</th><th>URL</th><th>সময়</th><th>রেকর্ডিং</th><th>অ্যাকশন</th></tr></thead><tbody id="liveClassTableBody"></tbody></table>
                </div>
            </section>
            <section id="certificate-management" class="content-section">
                <div class="page-header"><h1>সার্টিফিকেট ম্যানেজমেন্ট</h1></div>
                <div class="table-container">
                     <table><thead><tr><th>ছাত্রছাত্রীর নাম</th><th>কোর্সের নাম</th><th>সম্পন্ন করার তারিখ</th><th>অ্যাকশন</th></tr></thead><tbody id="certificateTableBody"></tbody></table>
                </div>
            </section>
            <section id="notifications" class="content-section">
                <div class="page-header"><h1>সকল ব্যবহারকারীকে বিজ্ঞপ্তি পাঠান</h1></div>
                <div class="settings-card">
                    <form id="notificationForm">
                        <div class="form-group">
                            <label for="notificationMessage">বিজ্ঞপ্তির বার্তা</label>
                            <textarea id="notificationMessage" rows="5" required placeholder="সকল ব্যবহারকারী তাদের ড্যাশবোর্ডে এই বার্তাটি দেখতে পাবে।"></textarea>
                        </div>
                        <button type="submit" class="submit-btn">বিজ্ঞপ্তি পাঠান</button>
                    </form>
                </div>
                 <div class="page-header" style="margin-top: 40px;"><h1>পূর্ববর্তী বিজ্ঞপ্তি</h1></div>
                 <div class="table-container">
                    <table>
                        <thead><tr><th>বার্তা</th><th>পাঠানোর তারিখ</th><th>অ্যাকশন</th></tr></thead>
                        <tbody id="sentNotificationsTableBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="group-messaging" class="content-section">
                <div class="page-header"><h1>গ্রুপ মেসেজিং (কোর্স অনুযায়ী)</h1></div>
                <div class="settings-card">
                    <form id="groupNotificationForm">
                        <div class="form-group">
                            <label for="groupNotificationCourse">কোর্স নির্বাচন করুন</label>
                            <select id="groupNotificationCourse" required></select>
                        </div>
                        <div class="form-group">
                            <label for="groupNotificationMessage">বিজ্ঞপ্তির বার্তা</label>
                            <textarea id="groupNotificationMessage" rows="5" required placeholder="শুধুমাত্র নির্বাচিত কোর্সের শিক্ষার্থীরা এই বার্তাটি পাবে।"></textarea>
                        </div>
                        <button type="submit" class="submit-btn">নির্বাচিত গ্রুপে পাঠান</button>
                    </form>
                </div>
            </section>

            <section id="qna-management" class="content-section">
                <div class="page-header"><h1>প্রশ্নোত্তর ম্যানেজমেন্ট</h1></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>কোর্স</th>
                                <th>পাঠ (Lesson)</th>
                                <th>ব্যবহারকারী</th>
                                <th style="min-width: 300px;">প্রশ্ন</th>
                                <th>অ্যাকশন</th>
                            </tr>
                        </thead>
                        <tbody id="qnaTableBody"></tbody>
                    </table>
                </div>
            </section>
             <section id="course-reviews" class="content-section">
                <div class="page-header"><h1>কোর্স রিভিউ ম্যানেজমেন্ট</h1></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>কোর্স</th><th>ব্যবহারকারী</th><th>রেটিং</th><th class="review-col">রিভিউ</th><th>স্ট্যাটাস</th><th>অ্যাকশন</th></tr></thead>
                        <tbody id="reviewsTableBody"></tbody>
                    </table>
                </div>
            </section>
            
            <section id="community-management" class="content-section">
                <div class="page-header"><h1>কমিউনিটি ফোরাম ম্যানেজমেন্ট</h1></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>পোস্টকারী</th><th>পোস্ট</th><th>তারিখ</th><th>অ্যাকশন</th></tr></thead>
                        <tbody id="forumPostsTableBody"></tbody>
                    </table>
                </div>
            </section>

            <section id="payment-history" class="content-section">
                <div class="page-header"><h1>পেমেন্ট হিস্ট্রি</h1></div>
                <button class="add-new-btn" onclick="openPaymentModal()">ম্যানুয়াল পেমেন্ট যোগ করুন</button>
                <div class="table-container">
                    <table>
                        <thead><tr><th>ব্যবহারকারী</th><th>কোর্স</th><th>পরিমাণ (BDT)</th><th>Transaction ID</th><th>তারিখ</th></tr></thead>
                        <tbody id="paymentHistoryTableBody"></tbody>
                    </table>
                </div>
                <div class="pagination-controls" id="paymentPaginationControls"></div>
            </section>
            <section id="support-tickets" class="content-section">
                <div class="page-header"><h1>সাপোর্ট টিকেট</h1></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>ব্যবহারকারী</th><th>বিষয়</th><th>বার্তা</th><th>Priority</th><th>Assigned To</th><th>স্ট্যাটাস</th><th>অ্যাকশন</th></tr></thead>
                        <tbody id="supportTicketsTableBody"></tbody>
                    </table>
                </div>
            </section>
            <section id="earnings" class="content-section">
                <div class="page-header"><h1>আর্নিং রিপোর্ট</h1></div>
                <div class="table-container">
                    <table><thead><tr><th>ট্রানজেকশন আইডি</th><th>ব্যবহারকারী</th><th>কোর্স</th><th>পরিমাণ (BDT)</th><th>তারিখ</th></tr></thead><tbody id="earningsTableBody"></tbody></table>
                </div>
            </section>
            <section id="project-management" class="content-section">
                <div class="page-header"><h1>আপকামিং প্রজেক্ট ম্যানেজমেন্ট</h1></div><button class="add-new-btn" onclick="openProjectModal()">নতুন প্রজেক্ট যোগ করুন</button>
                <div class="table-container">
                    <table><thead><tr><th>প্রজেক্টের নাম</th><th>লিংক</th><th>অ্যাকশন</th></tr></thead><tbody id="projectTableBody"></tbody></table>
                </div>
            </section>
            <section id="workshop-management" class="content-section">
                <div class="page-header"><h1>আসন্ন ওয়ার্কশপ ম্যানেজমেন্ট</h1></div>
                <div class="settings-card">
                    <form id="workshopForm">
                        <input type="hidden" id="workshopId" value="main_workshop">
                        <div class="form-group">
                            <label for="workshopTitle">ওয়ার্কশপের শিরোনাম</label>
                            <input type="text" id="workshopTitle" placeholder="যেমন: আগামী মাসের ফ্রিল্যান্সিং ওয়ার্কশপ" required>
                        </div>
                        <div class="form-group">
                            <label for="workshopDate">তারিখ ও সময়</label>
                            <input type="text" id="workshopDate" placeholder="যেমন: নভেম্বর ২৫, ২০২৫ - রাত ৯টা" required>
                        </div>
                        <div class="form-group">
                            <label for="workshopDescription">সংক্ষিপ্ত বিবরণ</label>
                            <textarea id="workshopDescription" rows="4" placeholder="ওয়ার্কশপে কী কী শেখানো হবে এবং প্রাসঙ্গিক WhatsApp গ্রুপের তথ্য দিন।"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="workshopRegLink">রেজিস্ট্রেশন লিংক</label>
                            <input type="text" id="workshopRegLink" placeholder="Google Form বা অন্য কোনো রেজিস্ট্রেশন পেজের লিংক" required>
                        </div>
                        <div class="form-group">
                            <label for="workshopStatus">স্ট্যাটাস</label>
                            <select id="workshopStatus">
                                <option value="active">সক্রিয় (ওয়েবসাইটে দেখাবে)</option>
                                <option value="inactive">নিষ্ক্রিয় (ওয়েবসাইটে দেখাবে না)</option>
                            </select>
                        </div>
                        <button type="submit" class="submit-btn">ওয়ার্কশপের তথ্য সেভ করুন</button>
                    </form>
                </div>
            </section>
            <section id="blog-management" class="content-section">
                <div class="page-header"><h1>ব্লগ/নোটিশ ম্যানেজমেন্ট</h1></div><button class="add-new-btn" onclick="openBlogModal()">নতুন পোস্ট যোগ করুন</button>
                <div class="table-container">
                    <table><thead><tr><th>শিরোনাম</th><th>স্ট্যাটাস</th><th>তারিখ</th><th>অ্যাকশন</th></tr></thead><tbody id="blogTableBody"></tbody></table>
                </div>
            </section>
            <section id="contact-messages" class="content-section">
                <div class="page-header"><h1>ব্যবহারকারীদের পাঠানো বার্তা</h1></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>নাম</th><th>ইমেইল</th><th>বার্তা</th><th>তারিখ</th><th>অ্যাকশন</th></tr></thead>
                        <tbody id="contactMessagesTableBody"></tbody>
                    </table>
                </div>
            </section>
            <section id="page-content" class="content-section">
                <div class="page-header"><h1>পেজ কনটেন্ট ম্যানেজমেন্ট</h1></div>
                
                <div class="settings-card">
                    <h3>স্টুডেন্ট ড্যাশবোর্ড অ্যানাউন্সমেন্ট</h3>
                    <form id="dashboardAnnouncementForm">
                        <div class="form-group">
                            <label for="dashboardAnnouncementText">বার্তার টেক্সট (লিংক সহ)</label>
                            <textarea id="dashboardAnnouncementText" rows="4" placeholder="e.g., আমাদের WhatsApp কমিউনিটিতে যোগ দিন: [লিংক]"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="dashboardAnnouncementStatus">স্ট্যাটাস</label>
                            <select id="dashboardAnnouncementStatus">
                                <option value="active">সক্রিয় (Active)</option>
                                <option value="inactive">নিষ্ক্রিয় (Inactive)</option>
                            </select>
                        </div>
                        <button type="submit" class="form-btn">সেভ করুন</button>
                    </form>
                </div>
               
                <div class="settings-card">
                    <h3>গ্লোবাল কনটেন্ট (সকল পেজের জন্য)</h3>
                    <form id="globalContentForm">
                        <div class="form-group">
                            <label for="blogFooterText">ব্লগ পোস্ট ফুটার টেক্সট</label>
                            <textarea id="blogFooterText" rows="3" placeholder="প্রতিটি ব্লগ পোস্টের নিচে এই লেখাটি দেখানো হবে। যেমন: আমাদের কমিউনিটিতে যোগ দিন..."></textarea>
                        </div>
                        <button type="submit" class="form-btn">সেভ করুন</button>
                    </form>
                </div>
               
                <div class="settings-card">
                    <h3>সেকশনের শিরোনামসমূহ</h3><form id="sectionTitlesForm"><h4>ফিচার সেকশন</h4><div class="form-group"><label for="featuresSubtitle">সাব-টাইটেল</label><input type="text" id="featuresSubtitle"></div><div class="form-group"><label for="featuresMainTitle">প্রধান শিরোনাম</label><input type="text" id="featuresMainTitle"></div><hr><h4>কোর্স সেকশন</h4><div class="form-group"><label for="coursesSubtitle">সাব-টাইটেল</label><input type="text" id="coursesSubtitle"></div><div class="form-group"><label for="coursesMainTitle">প্রধান শিরোনাম</label><input type="text" id="coursesMainTitle"></div><hr><h4>প্রজেক্ট সেকশন</h4><div class="form-group"><label for="projectsSubtitle">সাব-টাইটেল</label><input type="text" id="projectsSubtitle"></div><div class="form-group"><label for="projectsMainTitle">প্রধান শিরোনাম</label><input type="text" id="projectsMainTitle"></div><button type="submit" class="form-btn">শিরোনাম সেভ করুন</button></form>
                </div>
                <div class="settings-card">
                    <h3>ফিচার সেকশন ম্যানেজমেন্ট</h3><button class="add-new-btn" onclick="openFeatureModal()">নতুন ফিচার যোগ করুন</button>
                    <div class="table-container">
                        <table><thead><tr><th>আইকন URL</th><th>শিরোনাম</th><th>বর্ণনা</th><th>অ্যাকশন</th></tr></thead><tbody id="featuresTableBody"></tbody></table>
                    </div>
                </div>
                <div class="settings-card">
                    <h3>ইন্ট্রো ফুটার আইটেম</h3><form id="introFooterForm"><h4>আইটেম ১</h4><div class="form-group"><label for="introItem1Image">ছবির URL</label><input type="text" id="introItem1Image"></div><div class="form-group"><label for="introItem1Title">শিরোনাম</label><input type="text" id="introItem1Title"></div><hr><h4>আইটেম ২</h4><div class="form-group"><label for="introItem2Image">ছবির URL</label><input type="text" id="introItem2Image"></div><div class="form-group"><label for="introItem2Title">শিরোনাম</label><input type="text" id="introItem2Title"></div><hr><h4>আইটেম ৩</h4><div class="form-group"><label for="introItem3Image">ছবির URL</label><input type="text" id="introItem3Image"></div><div class="form-group"><label for="introItem3Title">শিরোনাম</label><input type="text" id="introItem3Title"></div><button type="submit" class="form-btn">আইটেম সেভ করুন</button></form>
                </div>
                <div class="settings-card">
                    <h3>সোশ্যাল মিডিয়া লিংক</h3><form id="socialLinksForm"><div class="form-group"><label for="facebookLink">Facebook</label><input type="text" id="facebookLink"></div><div class="form-group"><label for="telegramLink">Telegram</label><input type="text" id="telegramLink"></div><div class="form-group"><label for="twitterLink">Twitter</label><input type="text" id="twitterLink"></div><div class="form-group"><label for="youtubeLink">YouTube</label><input type="text" id="youtubeLink"></div><button type="submit" class="form-btn">লিংক সেভ করুন</button></form>
                </div>
            </section>
            <section id="text-seo-management" class="content-section">
                <div class="page-header"><h1>ওয়েবসাইটের টেক্সট ও SEO</h1></div>
                <div class="settings-card">
                    <h3>SEO ম্যানেজমেন্ট</h3>
                    <form id="seoForm">
                        <div class="form-group">
                            <label for="metaTitle">মেটা শিরোনাম (সার্চ ইঞ্জিনে দেখাবে)</label>
                            <input type="text" id="metaTitle" placeholder="e.g., Income Impact BD - Learn & Earn">
                        </div>
                        <div class="form-group">
                            <label for="metaDescription">মেটা বর্ণনা (গুগল সার্চে দেখাবে)</label>
                            <textarea id="metaDescription" rows="3" placeholder="A short description of your website."></textarea>
                        </div>
                        <button type="submit" class="form-btn">SEO তথ্য সেভ করুন</button>
                    </form>
                </div>
                <div class="settings-card">
                    <h3>Language Management (সাইটের টেক্সট)</h3>
                    <form id="languageForm">
                        <div class="grid-2-col">
                            <div class="form-group"><label for="lang-signInButton">Sign In বাটন</label><input type="text" id="lang-signInButton"></div>
                            <div class="form-group"><label for="lang-signUpButton">Sign Up বাটন</label><input type="text" id="lang-signUpButton"></div>
                            <div class="form-group"><label for="lang-dashboardButton">Dashboard বাটন</label><input type="text" id="lang-dashboardButton"></div>
                            <div class="form-group"><label for="lang-signOutButton">Sign Out বাটন</label><input type="text" id="lang-signOutButton"></div>
                            <div class="form-group"><label for="lang-adminLoginButton">Admin Login বাটন</label><input type="text" id="lang-adminLoginButton"></div>
                            <div class="form-group"><label for="lang-subadminLoginButton">Subadmin Login বাটন</label><input type="text" id="lang-subadminLoginButton"></div>
                            <div class="form-group"><label for="lang-contactFormMainTitle">Contact Form শিরোনাম</label><input type="text" id="lang-contactFormMainTitle"></div>
                            <div class="form-group"><label for="lang-contactSubmitButton">Contact Form বাটন</label><input type="text" id="lang-contactSubmitButton"></div>
                            <div class="form-group"><label for="lang-enrollNowButton">Enroll Now বাটন</label><input type="text" id="lang-enrollNowButton"></div>
                        </div>
                        <hr>
                        <h4>Modal & Dashboard Texts</h4>
                        <div class="grid-3-col">
                            <div class="form-group"><label for="lang-signInTitle">Sign In শিরোনাম</label><input type="text" id="lang-signInTitle"></div>
                            <div class="form-group"><label for="lang-signUpTitle">Sign Up শিরোনাম</label><input type="text" id="lang-signUpTitle"></div>
                            <div class="form-group"><label for="lang-forgotPasswordLink">Forgot Password লিংক</label><input type="text" id="lang-forgotPasswordLink"></div>
                            <div class="form-group"><label for="lang-tabOverview">Overview ট্যাব</label><input type="text" id="lang-tabOverview"></div>
                            <div class="form-group"><label for="lang-tabMyCourses">My Courses ট্যাব</label><input type="text" id="lang-tabMyCourses"></div>
                            <div class="form-group"><label for="lang-tabNotifications">Notifications ট্যাব</label><input type="text" id="lang-tabNotifications"></div>
                            <div class="form-group"><label for="lang-tabAchievements">Achievements ট্যাব</label><input type="text" id="lang-tabAchievements"></div>
                            <div class="form-group"><label for="lang-tabLeaderboard">Leaderboard ট্যাব</label><input type="text" id="lang-tabLeaderboard"></div>
                            <div class="form-group"><label for="lang-tabProfile">My Profile ট্যাব</label><input type="text" id="lang-tabProfile"></div>
                            <div class="form-group"><label for="lang-tabPayments">Payments ট্যাব</label><input type="text" id="lang-tabPayments"></div>
                        </div>
                         <hr>
                        <h4>নতুন যুক্ত করা সেকশনের শিরোনাম</h4>
                        <div class="grid-2-col">
                            <div class="form-group"><label for="title-liveClassSubtitle">লাইভ ক্লাস (সাব-টাইটেল)</label><input type="text" id="title-liveClassSubtitle"></div>
                            <div class="form-group"><label for="title-liveClassMainTitle">লাইভ ক্লাস (প্রধান শিরোনাম)</label><input type="text" id="title-liveClassMainTitle"></div>
                            <div class="form-group"><label for="title-communitySubtitle">কমিউনিটি (সাব-টাইটেল)</label><input type="text" id="title-communitySubtitle"></div>
                            <div class="form-group"><label for="title-communityMainTitle">কমিউনিটি (প্রধান শিরোনাম)</label><input type="text" id="title-communityMainTitle"></div>
                            <div class="form-group"><label for="title-workshopSubtitle">ওয়ার্কশপ (সাব-টাইটেল)</label><input type="text" id="title-workshopSubtitle"></div>
                            <div class="form-group"><label for="title-workshopMainTitle">ওয়ার্কশপ (প্রধান শিরোনাম)</label><input type="text" id="title-workshopMainTitle"></div>
                        </div>
                        <button type="submit" class="form-btn">টেক্সট সেভ করুন</button>
                    </form>
                </div>
            </section>
            <section id="menu-management" class="content-section">
                <div class="page-header"><h1>ন্যাভিগেশন মেনু ম্যানেজমেন্ট</h1></div><button class="add-new-btn" onclick="openMenuModal()">নতুন মেনু আইটেম যোগ করুন</button>
                <div class="table-container">
                    <table><thead><tr><th>নাম</th><th>URL</th><th>Order</th><th>অ্যাকশন</th></tr></thead><tbody id="menuTableBody"></tbody></table>
                </div>
            </section>
            <section id="role-management" class="content-section">
                <div class="page-header"><h1>সাব-অ্যাডমিন রোল ম্যানেজমেন্ট</h1></div><button class="add-new-btn" onclick="openRoleModal()">নতুন রোল যোগ করুন</button>
                <div class="table-container">
                    <table><thead><tr><th>রোলের নাম</th><th>ভ্যালু</th><th>অ্যাকশন</th></tr></thead><tbody id="roleTableBody"></tbody></table>
                </div>
            </section>
            <section id="mentor-management" class="content-section">
                <div class="page-header"><h1>মেন্টর ম্যানেজমেন্ট</h1></div>
                <div class="settings-card">
                    <form id="mentorRolesForm">
                        <h3>মেন্টর রোল নির্বাচন করুন</h3>
                        <p>ইউজার অ্যাপের 'Mentors' ট্যাবে কাদের দেখানো হবে তা এখান থেকে নির্বাচন করুন। 'Team Leader' এবং 'Trainer' রোল দুটি নির্বাচন করার পরামর্শ দেওয়া হচ্ছে।</p>
                        <div id="mentorRolesContainer" class="form-group">
                        </div>
                        <button type="submit" class="submit-btn">সেভ করুন</button>
                    </form>
                </div>
                <div class="page-header" style="margin-top: 40px;"><h1>মেন্টর পারফরম্যান্স</h1></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>মেন্টরের নাম</th><th>রোল</th><th>মোট লিড (পেন্ডিং)</th><th>মোট কনভার্ট (অ্যাক্টিভ)</th><th>অ্যাকশন</th></tr></thead>
                        <tbody id="mentorPerformanceTableBody"></tbody>
                    </table>
                </div>
            </section>
            <section id="referral-management" class="content-section">
                <div class="page-header"><h1>রেফারেল ম্যানেজমেন্ট</h1></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>রেফারকারীর নাম</th>
                                <th>রেফার করা ব্যবহারকারী</th>
                                <th>স্ট্যাটাস</th>
                                <th>যোগদানের তারিখ</th>
                            </tr>
                        </thead>
                        <tbody id="referralTableBody"></tbody>
                    </table>
                </div>
            </section>
            <section id="balance-logs" class="content-section">
                <div class="page-header"><h1>ম্যানুয়াল ব্যালেন্স পরিবর্তনের লগ</h1></div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>তারিখ ও সময়</th>
                                <th>ব্যবহারকারী</th>
                                <th>অ্যাডমিন</th>
                                <th>পূর্বের ব্যালেন্স</th>
                                <th>নতুন ব্যালেন্স</th>
                                <th>কারণ</th>
                            </tr>
                        </thead>
                        <tbody id="balanceLogsTableBody"></tbody>
                    </table>
                </div>
            </section>
            <section id="country-code-management" class="content-section">
                <div class="page-header"><h1>কান্ট্রি কোড ম্যানেজমেন্ট</h1></div>
                <button class="add-new-btn" onclick="openCountryCodeModal()">নতুন কান্ট্রি কোড যোগ করুন</button>
                <div class="table-container">
                    <table>
                        <thead><tr><th>দেশের নাম</th><th>কোড</th><th>অ্যাকশন</th></tr></thead>
                        <tbody id="countryCodeTableBody"></tbody>
                    </table>
                </div>
            </section>
            <section id="activity-logs" class="content-section">
                <div class="page-header"><h1>অ্যাডমিন অ্যাক্টিভিটি লগ</h1></div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>সময়</th><th>অ্যাডমিন</th><th>অ্যাকশন</th><th style="min-width: 300px;">বিস্তারিত</th></tr></thead>
                        <tbody id="activityLogsTableBody"></tbody>
                    </table>
                </div>
            </section>
            <section id="footer-management" class="content-section">
                <div class="page-header"><h1>ফুটার ম্যানেজমেন্ট</h1></div><button class="add-new-btn" onclick="openFooterLinkModal()">নতুন ফুটার লিংক যোগ করুন</button>
                <div class="table-container">
                    <table><thead><tr><th>লিংকের নাম</th><th>লিংকের URL</th><th>অ্যাকশন</th></tr></thead><tbody id="footerLinksTableBody"></tbody></table>
                </div>
            </section>
            <section id="gamification-settings" class="content-section">
                <div class="page-header"><h1>গ্যামিফিকেশন সেটিংস</h1></div>
                <div class="settings-card">
                    <form id="gamificationForm">
                         <h3>পয়েন্ট সিস্টেম পরিচালনা</h3>
                         <div class="form-group">
                             <label for="pointsPerLesson">প্রতিটি পাঠ শেষ করার জন্য পয়েন্ট</label>
                             <input type="number" id="pointsPerLesson" placeholder="e.g., 10">
                         </div>
                         <div class="form-group">
                             <label for="pointsPerQuiz">প্রতিটি কুইজ পাশ করার জন্য পয়েন্ট</label>
                             <input type="number" id="pointsPerQuiz" placeholder="e.g., 50">
                         </div>
                         <button type="submit" class="submit-btn">পয়েন্ট সেটিংস সেভ করুন</button>
                    </form>
                </div>
                <div class="settings-card">
                    <h3>ব্যাজ ম্যানেজমেন্ট</h3>
                    <button class="add-new-btn" onclick="openBadgeModal()">নতুন ব্যাজ যোগ করুন</button>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>ব্যাজের নাম</th><th>আইকন (Font Awesome)</th><th>শর্ত</th><th>অ্যাকশন</th></tr></thead>
                            <tbody id="badgesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            <section id="settings" class="content-section">
                <div class="page-header"><h1>ওয়েবসাইট সেটিংস ও থিম</h1></div>
                <div class="settings-card">
                    <form id="settingsForm">
                        <h3>সাধারণ সেটিংস</h3>
                        <div class="form-group">
                            <label for="siteTitle">ওয়েবসাইটের শিরোনাম</label>
                            <input type="text" id="siteTitle">
                        </div>
                        <div class="form-group">
                            <label for="bannerText">ব্যানারের লেখা</label>
                            <textarea id="bannerText" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="aboutAdminText">"About Admin" সেকশনের লেখা</label>
                            <textarea id="aboutAdminText" rows="6"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="logoUrl">লোগোর URL</label>
                            <input type="text" id="logoUrl">
                        </div>
                        <div class="form-group">
                            <label for="copyrightText">কপিরাইট লেখা</label>
                            <input type="text" id="copyrightText">
                        </div>
                        <hr><h3>নিবন্ধন কন্ট্রোল</h3>
                        <div class="form-group">
                            <label for="allowRegistration">নতুন ব্যবহারকারী রেজিস্ট্রেশন</label>
                            <select id="allowRegistration">
                                <option value="true">চালু (Enabled)</option>
                                <option value="false">বন্ধ (Disabled)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mainWhatsappLink">প্রধান WhatsApp কমিউনিটি লিংক</label>
                            <input type="url" id="mainWhatsappLink" placeholder="https://chat.whatsapp.com/...">
                        </div>
                        <hr><h3>Referral & Bonus Settings</h3>
                        <div class="form-group">
                            <label for="newUserBonus">নতুন ব্যবহারকারীর অ্যাক্টিভেশন বোনাস (BDT)</label>
                            <input type="number" id="newUserBonus" placeholder="e.g., 400">
                        </div>
                        <div class="form-group">
                            <label for="referrerBonus">সাধারণ রেফারকারীর বোনাস (BDT)</label>
                            <input type="number" id="referrerBonus" placeholder="e.g., 160">
                        </div>
                        <div class="form-group">
                            <label for="mentorReferrerBonus">মেন্টর (Team Leader/Trainer) রেফারকারীর বোনাস (BDT)</label>
                            <input type="number" id="mentorReferrerBonus" placeholder="e.g., 50">
                        </div>
                        <hr><h3>থিম কাস্টমাইজেশন</h3><div class="form-group"><label for="primaryColor">প্রাইমারি রঙ</label><input type="color" id="primaryColor" style="width: 100px; height: 40px;"></div><div class="form-group"><label for="secondaryColor">সেকেন্ডারি রঙ</label><input type="color" id="secondaryColor" style="width: 100px; height: 40px;"></div><hr>
                        <h3>পেজের ছবিসমূহ</h3>
                        <div class="form-group"><label for="bannerImageUrl">ব্যানার ছবির URL</label><input type="text" id="bannerImageUrl"></div>
                        <div class="form-group"><label for="aboutImageUrl">About ছবির URL</label><input type="text" id="aboutImageUrl"></div>
                        <div class="form-group"><label for="projectsImageUrl">Projects ছবির URL</label><input type="text" id="projectsImageUrl"></div>
                        <hr>
                        <h3>অ্যানাউন্সমেন্ট পপ-আপ</h3>
                        <div class="form-group"><label for="announcementTitle">পপ-আপ শিরোনাম</label><input type="text" id="announcementTitle"></div>
                        <div class="form-group"><label for="announcementMessage">বার্তা</label><textarea id="announcementMessage" rows="3"></textarea></div>
                        <div class="form-group">
                            <label for="announcementStatus">স্ট্যাটাস</label>
                            <select id="announcementStatus">
                                <option value="active">সক্রিয় (Active)</option>
                                <option value="inactive">নিষ্ক্রিয় (Inactive)</option>
                            </select>
                        </div>
                        <hr>
                        <h3>যোগাযোগ ও ফুটার</h3><div class="form-group"><label for="contactEmail">যোগাযোগের ইমেইল</label><input type="email" id="contactEmail"></div><div class="form-group"><label for="contactPhone">যোগাযোগের ফোন</label><input type="text" id="contactPhone"></div><div class="form-group"><label for="contactAddress">ঠিকানা</label><input type="text" id="contactAddress"></div><div class="form-group"><label for="footerDescription">ফুটারের বিবরণ</label><textarea id="footerDescription" rows="4"></textarea></div><hr>
                        <h3>ডেভেলপার ক্রেডিট</h3><div class="form-group"><label for="developerName">ডেভেলপারের নাম</label><input type="text" id="developerName"></div><div class="form-group"><label for="developerUrl">ডেভেলপারের URL</label><input type="text" id="developerUrl"></div>
                        <button type="submit" class="form-btn">সেটিংস সেভ করুন</button>
                        <hr><h3>ডেটা ম্যানেজমেন্ট</h3>
                        <button type="button" class="form-btn" style="background-color: var(--warning-color);" onclick="backupData()">ডেটা ডাউনলোড করুন (Backup)</button>
                        <button type="button" class="form-btn" style="background-color: var(--danger-color);" onclick="seedDatabaseWithInitialData()">Initialize Site with Sample Data</button>
                    </form>
                </div>
            </section>
        </main>
    </div>
    
    <div id="userModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="userModalTitle"></h2><span class="close-btn" onclick="closeModal('userModal')">&times;</span></div>
    <form id="userForm"><input type="hidden" id="userId">
        <div class="form-group"><label for="userName">নাম</label><input type="text" id="userName" required></div>
        <div class="form-group"><label for="userEmail">ইমেইল</label><input type="email" id="userEmail" required></div>
        <div class="form-group"><label for="userProfilePicUrl">প্রোফাইল ছবির URL</label><input type="text" id="userProfilePicUrl"></div>
        <div class="form-group"><label for="userBalance">ব্যালেন্স</label><input type="number" id="userBalance"></div>
        <div class="form-group"><label for="balanceReason">ব্যালেন্স পরিবর্তনের কারণ (ঐচ্ছিক)</label><textarea id="balanceReason" rows="2"></textarea></div>
        <div class="form-group"><label for="userRole">রোল (e.g., Team Leader)</label><input type="text" id="userRole" placeholder="Optional"></div>
        <div class="form-group"><label for="userCountryCode">Country Code</label><input type="text" id="userCountryCode" placeholder="+880"></div>
        <div class="form-group"><label for="userWhatsapp">হোয়াটসঅ্যাপ নম্বর</label><input type="text" id="userWhatsapp" placeholder="Optional"></div>
        <div class="form-group"><label for="userPoints">পয়েন্ট</label><input type="number" id="userPoints"></div>
        <div class="form-group"><label for="userStatus">স্ট্যাটাস</label><select id="userStatus"><option value="active">Active</option><option value="pending">Pending</option><option value="blocked">Blocked</option></select></div>
        <button type="submit" class="submit-btn">সেভ করুন</button>
    </form></div></div>

    <div id="courseModal" class="modal"><div class="modal-content" style="max-height: 80vh; overflow-y: auto;"><div class="modal-header"><h2 id="courseModalTitle"></h2><span class="close-btn" onclick="closeModal('courseModal')">&times;</span></div>
    <form id="courseForm"><input type="hidden" id="courseId">
        <div class="form-group"><label for="courseName">কোর্সের নাম</label><input type="text" id="courseName" required></div>
        <div class="form-group"><label for="courseCategory">ক্যাটাগরি</label><select id="courseCategory" required></select></div>
        <div class="form-group"><label for="coursePrice">মূল্য (BDT)</label><input type="number" id="coursePrice" required></div>
        <!-- NEW 'Order' INPUT FIELD ADDED -->
        <div class="form-group"><label for="courseOrder">Order (for sorting)</label><input type="number" id="courseOrder" value="0"></div>
        <div class="form-group"><label for="courseHomeworkReward">হোমওয়ার্ক রিওয়ার্ড (BDT)</label><input type="number" id="courseHomeworkReward" value="0"></div>
        <div class="form-group"><label for="courseHomeworkLimit">হোমওয়ার্ক লিমিট</label><input type="number" id="courseHomeworkLimit" value="0"></div>
        <div class="form-group"><label for="courseImageURL"> ছবির URL</label><input type="text" id="courseImageURL"></div>
        <div class="form-group">
            <label for="courseWhatsappLink">কোর্স WhatsApp গ্রুপ লিংক (ঐচ্ছিক)</label>
            <input type="url" id="courseWhatsappLink" placeholder="এই কোর্সের জন্য নির্দিষ্ট গ্রুপের লিংক দিন">
        </div>
        <div class="form-group"><label for="courseTrailerURL">ট্রেইলার ভিডিও URL (YouTube)</label><input type="text" id="courseTrailerURL" placeholder="https://www.youtube.com/watch?v=..."></div>
        <div class="form-group"><label for="coursePassMark">কুইজ পাশ মার্ক (%)</label><input type="number" id="coursePassMark" min="0" max="100" value="50"></div>
        <div class="form-group"><label for="courseDescription">বিস্তারিত বিবরণ</label><textarea id="courseDescription" rows="5"></textarea></div>
        <div class="form-group"><label for="courseStatus">স্ট্যাটাস</label><select id="courseStatus"><option value="published">পাবলিশড</option><option value="pending">পেন্ডিং</option></select></div>
        <button type="submit" class="submit-btn">সেভ করুন</button>
    </form></div></div>
    
    <div id="categoryModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="categoryModalTitle"></h2><span class="close-btn" onclick="closeModal('categoryModal')">&times;</span></div><form id="categoryForm"><input type="hidden" id="categoryId"><div class="form-group"><label for="categoryName">ক্যাটাগরির নাম</label><input type="text" id="categoryName" required></div><button type="submit" class="submit-btn">সেভ করুন</button></form></div></div>

    <div id="badgeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="badgeModalTitle">নতুন ব্যাজ</h2>
                <span class="close-btn" onclick="closeModal('badgeModal')">&times;</span>
            </div>
            <form id="badgeForm">
                <input type="hidden" id="badgeId">
                <div class="form-group"><label for="badgeName">ব্যাজের নাম</label><input type="text" id="badgeName" required></div>
                <div class="form-group"><label for="badgeIcon">আইকন (e.g., fas fa-trophy)</label><input type="text" id="badgeIcon" required></div>
                <div class="form-group"><label for="badgeType">শর্তের ধরন</label>
                    <select id="badgeType">
                        <option value="complete_courses">কোর্স সম্পন্ন করা</option>
                    </select>
                </div>
                <div class="form-group"><label for="badgeValue">প্রয়োজনীয় সংখ্যা (e.g., 5)</label><input type="number" id="badgeValue" required></div>
                <button type="submit" class="submit-btn">সেভ করুন</button>
            </form>
        </div>
    </div>
    
    <div id="manualBadgeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="manualBadgeModalTitle">ব্যবহারকারীকে ব্যাজ দিন</h2>
                <span class="close-btn" onclick="closeModal('manualBadgeModal')">&times;</span>
            </div>
            <form id="manualBadgeForm">
                <input type="hidden" id="manualBadgeUserId">
                <div class="form-group">
                    <label for="manualBadgeSelect">একটি ব্যাজ নির্বাচন করুন</label>
                    <select id="manualBadgeSelect" required></select>
                </div>
                <button type="submit" class="submit-btn">ব্যাজ প্রদান করুন</button>
            </form>
        </div>
    </div>

    <div id="projectModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="projectModalTitle"></h2><span class="close-btn" onclick="closeModal('projectModal')">&times;</span></div><form id="projectForm"><input type="hidden" id="projectId"><div class="form-group"><label for="projectTitle">প্রজেক্টের নাম</label><input type="text" id="projectTitle" required></div><div class="form-group"><label for="projectLink">লিংক</label><input type="text" id="projectLink" required></div><button type="submit" class="submit-btn">সেভ করুন</button></form></div></div>
    <div id="footerLinkModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="footerLinkModalTitle"></h2><span class="close-btn" onclick="closeModal('footerLinkModal')">&times;</span></div><form id="footerLinkForm"><input type="hidden" id="footerLinkId"><div class="form-group"><label for="footerLinkName">লিংকের নাম</label><input type="text" id="footerLinkName" required></div><div class="form-group"><label for="footerLinkUrl">লিংকের URL</label><input type="text" id="footerLinkUrl" required></div><button type="submit" class="submit-btn">সেভ করুন</button></form></div></div>
    <div id="blogModal" class="modal"><div class="modal-content" style="max-height: 80vh; overflow-y: auto;"><div class="modal-header"><h2 id="blogModalTitle"></h2><span class="close-btn" onclick="closeModal('blogModal')">&times;</span></div><form id="blogForm"><input type="hidden" id="blogId"><div class="form-group"><label for="blogTitle">শিরোনাম</label><input type="text" id="blogTitle" required></div><div class="form-group"><label for="blogImageUrl">ছবির URL</label><input type="text" id="blogImageUrl"></div><div class="form-group"><label for="blogContent">কনটেন্ট</label><textarea id="blogContent" rows="8" required></textarea></div><div class="form-group"><label for="blogStatus">স্ট্যাটাস</label><select id="blogStatus"><option value="published">পাবলিশড</option><option value="pending">পেন্ডিং</option></select></div><button type="submit" class="submit-btn">সেভ করুন</button></form></div></div>
    <div id="menuModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="menuModalTitle"></h2><span class="close-btn" onclick="closeModal('menuModal')">&times;</span></div><form id="menuForm"><input type="hidden" id="menuId"><div class="form-group"><label for="menuName">মেনুর নাম</label><input type="text" id="menuName" required></div><div class="form-group"><label for="menuUrl">URL</label><input type="text" id="menuUrl" required></div><div class="form-group"><label for="menuOrder">Order</label><input type="number" id="menuOrder" required></div><button type="submit" class="submit-btn">সেভ করুন</button></form></div></div>
    
    <!-- ROLE MODAL WITH NEW PERMISSIONS SECTION -->
    <div id="roleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="roleModalTitle"></h2><span class="close-btn" onclick="closeModal('roleModal')">&times;</span>
            </div>
            <form id="roleForm">
                <input type="hidden" id="roleId">
                <div class="form-group"><label for="roleName">রোলের নাম</label><input type="text" id="roleName" required></div>
                <div class="form-group"><label for="roleValue">ভ্যালু</label><input type="number" id="roleValue" required></div>
                
                <!-- NEW PERMISSIONS FIELDSET START -->
                <fieldset class="permissions-fieldset">
                    <legend>Permissions</legend>
                    <div class="permissions-grid">
                        <div class="permission-item">
                            <input type="checkbox" id="perm-can_manage_users" value="can_manage_users"><label for="perm-can_manage_users">Manage Users</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-can_manage_courses" value="can_manage_courses"><label for="perm-can_manage_courses">Manage Courses</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-can_review_homework" value="can_review_homework"><label for="perm-can_review_homework">Review Homework</label>
                        </div>
                         <div class="permission-item">
                            <input type="checkbox" id="perm-can_manage_payments" value="can_manage_payments"><label for="perm-can_manage_payments">Manage Payments</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-can_manage_blog" value="can_manage_blog"><label for="perm-can_manage_blog">Manage Blog</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm-can_answer_tickets" value="can_answer_tickets"><label for="perm-can_answer_tickets">Answer Tickets</label>
                        </div>
                         <div class="permission-item">
                            <input type="checkbox" id="perm-can_view_analytics" value="can_view_analytics"><label for="perm-can_view_analytics">View Analytics</label>
                        </div>
                    </div>
                </fieldset>
                <!-- NEW PERMISSIONS FIELDSET END -->

                <button type="submit" class="submit-btn" style="margin-top: 20px;">সেভ করুন</button>
            </form>
        </div>
    </div>
    
    <div id="featureModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="featureModalTitle"></h2><span class="close-btn" onclick="closeModal('featureModal')">&times;</span></div><form id="featureForm"><input type="hidden" id="featureId"><div class="form-group"><label for="featureImage">আইকন URL</label><input type="text" id="featureImage" required></div><div class="form-group"><label for="featureTitle">শিরোনাম</label><input type="text" id="featureTitle" required></div><div class="form-group"><label for="featureDesc">ছোট বর্ণনা</label><textarea id="featureDesc" rows="3"></textarea></div><button type="submit" class="submit-btn">সেভ করুন</button></form></div></div>
    <div id="enrollModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="enrollModalTitle">Enroll User in Course</h2><span class="close-btn" onclick="closeModal('enrollModal')">&times;</span></div><form id="enrollForm"><input type="hidden" id="enrollUserId"><div class="form-group"><label for="enrollCourseSelect">Select Course</label><select id="enrollCourseSelect" required></select></div><button type="submit" class="submit-btn">Enroll User</button></form></div></div>
    <div id="couponModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="couponModalTitle">Add New Coupon</h2><span class="close-btn" onclick="closeModal('couponModal')">&times;</span></div><form id="couponForm"><input type="hidden" id="couponId"><div class="form-group"><label for="couponCode">কুপন কোড</label><input type="text" id="couponCode" style="text-transform:uppercase" required></div><div class="form-group"><label for="couponType">ডিসকাউন্টের ধরন</label><select id="couponType"><option value="percentage">ש процентов</option><option value="fixed">סכום קבוע (BDT)</option></select></div><div class="form-group"><label for="couponValue">مقدار</label><input type="number" id="couponValue" required></div><div class="form-group"><label for="couponExpiry">মেয়াদ শেষ হওয়ার তারিখ (ঐচ্ছিক)</label><input type="date" id="couponExpiry"></div><button type="submit" class="submit-btn">সেভ করুন</button></form></div></div>
    <div id="courseContentModal" class="modal"><div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;"><div class="modal-header"><h2 id="courseContentModalTitle">Manage Course Content</h2><span class="close-btn" onclick="closeModal('courseContentModal')">&times;</span></div><div id="modulesContainer"></div><hr><h4>নতুন মডিউল যোগ করুন</h4><form id="addModuleForm" style="display: flex; gap: 10px;"><input type="text" id="newModuleName" placeholder="মডিউলের নাম" style="flex-grow: 1;" required><button type="submit" class="add-new-btn" style="margin: 0;">যোগ করুন</button></form></div></div>
    <div id="quizModal" class="modal"><div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;"><div class="modal-header"><h2 id="quizModalTitle">Manage Quiz</h2><span class="close-btn" onclick="closeModal('quizModal')">&times;</span></div><div id="quizQuestionsContainer"></div><hr><h4>Add New Question</h4><form id="addQuestionForm"><div class="form-group"><label>Question</label><input type="text" id="newQuestionText" required></div><div class="form-group"><label>Option 1</label><input type="text" class="quiz-option" required></div><div class="form-group"><label>Option 2</label><input type="text" class="quiz-option" required></div><div class="form-group"><label>Option 3</label><input type="text" class="quiz-option"></div><div class="form-group"><label>Option 4</label><input type="text" class="quiz-option"></div><div class="form-group"><label>Correct Answer (1-4)</label><input type="number" id="newCorrectAnswer" min="1" max="4" required></div><button type="submit" class="add-new-btn">Add Question</button></form></div></div>
    <div id="userProgressModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="userProgressModalTitle">Student Progress</h2><span class="close-btn" onclick="closeModal('userProgressModal')">&times;</span></div><div id="userProgressContainer"></div></div></div>
    <div id="userNotesModal" class="modal"><div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;"><div class="modal-header"><h2 id="userNotesModalTitle">Student Notes</h2><span class="close-btn" onclick="closeModal('userNotesModal')">&times;</span></div><div id="userNotesContainer"></div></div></div>
    
    <div id="countryCodeModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="countryCodeModalTitle"></h2><span class="close-btn" onclick="closeModal('countryCodeModal')">&times;</span></div><form id="countryCodeForm"><input type="hidden" id="countryCodeId"><div class="form-group"><label for="countryName">দেশের নাম</label><input type="text" id="countryName" required></div><div class="form-group"><label for="countryCodeValue">কান্ট্রি কোড (+ সহ)</label><input type="text" id="countryCodeValue" placeholder="+880" required></div><button type="submit" class="submit-btn">সেভ করুন</button></form></div></div>

    <!-- ======================== NEW MODALS START HERE ======================== -->
    <div id="createUserModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="createUserModalTitle">নতুন ইউজার তৈরি করুন</h2><span class="close-btn" onclick="closeModal('createUserModal')">&times;</span></div><form id="createUserForm"><div class="form-group"><label for="createUserName">নাম</label><input type="text" id="createUserName" required></div><div class="form-group"><label for="createUserEmail">ইমেইল</label><input type="email" id="createUserEmail" required></div><div class="form-group"><label for="createUserPassword">পাসওয়ার্ড</label><input type="password" id="createUserPassword" required></div><button type="submit" class="submit-btn">ইউজার তৈরি করুন</button></form></div></div>
    <div id="paymentModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="paymentModalTitle">ম্যানুয়াল পেমেন্ট যোগ করুন</h2><span class="close-btn" onclick="closeModal('paymentModal')">&times;</span></div><form id="paymentForm"><div class="form-group"><label for="paymentUserSelect">ব্যবহারকারী নির্বাচন করুন</label><select id="paymentUserSelect" required></select></div><div class="form-group"><label for="paymentCourseSelect">কোর্স নির্বাচন করুন</label><select id="paymentCourseSelect" required></select></div><div class="form-group"><label for="paymentAmount">টাকার পরিমাণ (BDT)</label><input type="number" id="paymentAmount" required></div><div class="form-group"><label for="paymentDate">পেমেন্টের তারিখ</label><input type="datetime-local" id="paymentDate" required></div><div class="form-group"><label for="paymentTxId">Transaction ID</label><input type="text" id="paymentTxId" value="MANUAL_ENTRY" required></div><button type="submit" class="submit-btn">পেমেন্ট যোগ করুন</button></form></div></div>
    <div id="homeworkModal" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="homeworkModalTitle">ম্যানুয়াল হোমওয়ার্ক যোগ করুন</h2><span class="close-btn" onclick="closeModal('homeworkModal')">&times;</span></div><form id="homeworkForm"><div class="form-group"><label for="homeworkUserSelect">ব্যবহারকারী নির্বাচন করুন</label><select id="homeworkUserSelect" required></select></div><div class="form-group"><label for="homeworkCourseSelect">কোর্স নির্বাচন করুন</label><select id="homeworkCourseSelect" required></select></div><div class="form-group"><label for="homeworkLink">হোমওয়ার্ক লিংক</label><input type="url" id="homeworkLink" value="https://example.com/manual-submission" required></div><div class="form-group"><label for="homeworkStatus">স্ট্যাটাস</label><select id="homeworkStatus"><option value="submitted">Submitted</option><option value="approved">Approved</option><option value="rejected">Rejected</option><option value="correction_needed">Correction Needed</option></select></div><div class="form-group"><label for="homeworkDate">জমা দেওয়ার তারিখ</label><input type="datetime-local" id="homeworkDate" required></div><button type="submit" class="submit-btn">হোমওয়ার্ক যোগ করুন</button></form></div></div>
    <div id="viewStudentsModal" class="modal"><div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;"><div class="modal-header"><h2 id="viewStudentsModalTitle"></h2><span class="close-btn" onclick="closeModal('viewStudentsModal')">&times;</span></div><div class="table-container"><table id="studentsTable"><thead><tr><th>নাম</th><th>ইমেইল</th><th>অগ্রগতি</th></tr></thead><tbody id="studentsTableBody"></tbody></table></div></div></div>
    
    <div id="mentorLeadsModal" class="modal"><div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;"><div class="modal-header"><h2 id="mentorLeadsModalTitle">মেন্টরের লিডসমূহ</h2><span class="close-btn" onclick="closeModal('mentorLeadsModal')">&times;</span></div><div id="mentorLeadsContainer"></div></div></div>
    <!-- ========================= NEW MODALS END HERE ========================= -->

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // REMOVED hardcoded password check for security.
            
            document.getElementById('login-btn').addEventListener('click', () => {
                // This simulates a successful login without asking for the password again
                // As requested, the password check is implicit.
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                initializeAppWithFirebase();
            });
        });

        function initializeAppWithFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyAARwxCzudakwIfyZT_CKkF-CUep-NlKPE",
                authDomain: "income-impact-pro.firebaseapp.com",
                projectId: "income-impact-pro",
                storageBucket: "income-impact-pro.firebasestorage.app",
                messagingSenderId: "935646225143",
                appId: "1:935646225143:web:c37289c1603d1a49b4e9f2"
            };
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            const auth = firebase.auth();

            const adminUid = "vcwR2irXaiTNiiOb5o0pBrIqfRV2";

            auth.onAuthStateChanged(user => {
                if (user && user.uid === adminUid) {
                    console.log("Admin is signed in.");
                    initializeApp();
                } else {
                    console.error("Access Denied. Please log in as admin via Firebase Console.");
                    document.body.innerHTML = `<div style="text-align: center; padding-top: 50px;"><h1>Access Denied</h1><p>You do not have permission to view this page. Please log in with the correct admin account via the Firebase console or your authentication provider.</p></div>`;
                }
            });
            
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                auth.signOut().then(() => {
                    alert("You have been logged out.");
                    document.body.innerHTML = `<div style="text-align: center; padding-top: 50px;"><h1>Logged Out</h1><p>Please close this page.</p></div>`;
                });
            });

            let allUsers = {}, allCourses = {}, allEarnings = {}, allProjects = {}, allFooterLinks = {}, allBlogPosts = {}, allMenus = {}, allRoles = {}, allFeatures = {}, allContactMessages = {};
            let allPayments = {}, allSupportTickets = {}, allReviews = {}, allCoupons = {}, allNotifications = {}, allLiveClasses = {};
            let allHomework = {}, allWithdrawals = {}, allCategories = {}, allBalanceLogs = {}, allCountryCodes = {}, allActivityLogs = {};
            let currentEditingCourseId = null, currentEditingModuleId = null;
            let userGrowthChartInstance = null, monthlyRevenueChartInstance = null;
            
            let userCurrentPage = 1, paymentCurrentPage = 1, homeworkCurrentPage = 1, courseCurrentPage = 1;
            const usersPerPage = 10, paymentsPerPage = 10, homeworksPerPage = 10, coursesPerPage = 10;
            let filteredUserKeys = [], filteredPaymentKeys = [], filteredHomeworkKeys = [], filteredCourseKeys = [];

            function initializeApp() {
                setupNavigation(); 
                setupEventListeners(); 
                setupMobileMenu(); 
                listenToFirebaseData();
            }

            function logAdminActivity(action, details = {}) {
                const user = auth.currentUser;
                if (!user) return;

                const logEntry = {
                    adminEmail: user.email,
                    action: action,
                    details: details,
                    timestamp: new Date().toISOString()
                };
                database.ref('adminActivityLogs').push(logEntry);
            }

            function setupMobileMenu() { const t = document.getElementById("menuToggle"), e = document.getElementById("sidebar"); t.addEventListener("click", (() => e.classList.toggle("show"))) }
            function setupNavigation() { const t = document.querySelectorAll(".nav-link"), e = document.querySelectorAll(".content-section"), n = document.getElementById("sidebar"); t.forEach((l => { l.addEventListener("click", (s => { s.preventDefault(), t.forEach((t => t.classList.remove("active"))), l.classList.add("active"); const o = l.getAttribute("href").substring(1); e.forEach((t => { t.classList.remove("active"), t.id === o && t.classList.add("active") })), window.innerWidth <= 768 && n.classList.remove("show") })) })) }
            
            window.openCreateUserModal = function() {
                openModal("createUserModal", "নতুন ইউজার তৈরি করুন", "createUserForm");
            }

            window.openPaymentModal = function() {
                const userSelect = document.getElementById('paymentUserSelect');
                userSelect.innerHTML = '<option value="">ব্যবহারকারী নির্বাচন...</option>';
                for (const userId in allUsers) {
                    userSelect.innerHTML += `<option value="${userId}">${allUsers[userId].name} (${allUsers[userId].email})</option>`;
                }
                const courseSelect = document.getElementById('paymentCourseSelect');
                courseSelect.innerHTML = '<option value="">কোর্স নির্বাচন...</option>';
                for (const courseId in allCourses) {
                    courseSelect.innerHTML += `<option value="${courseId}">${allCourses[courseId].name}</option>`;
                }
                openModal("paymentModal", "ম্যানুয়াল পেমেন্ট যোগ করুন", "paymentForm");
            }

            window.openHomeworkModal = function() {
                const userSelect = document.getElementById('homeworkUserSelect');
                userSelect.innerHTML = '<option value="">ব্যবহারকারী নির্বাচন...</option>';
                for (const userId in allUsers) {
                    userSelect.innerHTML += `<option value="${userId}">${allUsers[userId].name} (${allUsers[userId].email})</option>`;
                }
                const courseSelect = document.getElementById('homeworkCourseSelect');
                courseSelect.innerHTML = '<option value="">কোর্স নির্বাচন...</option>';
                for (const courseId in allCourses) {
                    courseSelect.innerHTML += `<option value="${courseId}">${allCourses[courseId].name}</option>`;
                }
                openModal("homeworkModal", "ম্যানুয়াল হোমওয়ার্ক যোগ করুন", "homeworkForm");
            }

            function handleCreateUser(event) {
                event.preventDefault();
                const name = document.getElementById('createUserName').value;
                const email = document.getElementById('createUserEmail').value;
                const password = document.getElementById('createUserPassword').value;
                
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const userData = {
                            name: name,
                            email: email,
                            regDate: new Date().toISOString(),
                            status: 'active',
                            balance: 0,
                            referralCode: 'REF' + Math.random().toString(36).substring(2, 10).toUpperCase(),
                            gamification: { points: 0, badges: {} }
                        };
                        database.ref('users/' + userCredential.user.uid).set(userData)
                            .then(() => {
                                logAdminActivity('User Created', { userId: userCredential.user.uid, email: email });
                                alert('ব্যবহারকারী সফলভাবে তৈরি এবং সক্রিয় করা হয়েছে!');
                                closeModal('createUserModal');
                            })
                            .catch(error => {
                                alert('ডাটাবেস ত্রুটি: ' + error.message);
                            });
                    })
                    .catch(error => {
                        alert('অথেন্টিকেশন ত্রুটি: ' + error.message);
                    });
            }

            function handleManualPayment(event) {
                event.preventDefault();
                const userId = document.getElementById('paymentUserSelect').value;
                const courseId = document.getElementById('paymentCourseSelect').value;
                const paymentData = {
                    userId: userId,
                    courseId: courseId,
                    amount: parseFloat(document.getElementById('paymentAmount').value),
                    date: new Date(document.getElementById('paymentDate').value).toISOString(),
                    transactionId: document.getElementById('paymentTxId').value,
                };

                database.ref('payments').push(paymentData)
                    .then(() => {
                        logAdminActivity('Manual Payment Added', { userId: userId, amount: paymentData.amount });
                        alert('পেমেন্ট হিস্ট্রি সফলভাবে যোগ করা হয়েছে!');
                        closeModal('paymentModal');
                    })
                    .catch(error => alert('ত্রুটি: ' + error.message));
            }

            function handleManualHomework(event) {
                event.preventDefault();
                const userId = document.getElementById('homeworkUserSelect').value;
                const courseId = document.getElementById('homeworkCourseSelect').value;
                const course = allCourses[courseId] || {};
                
                const homeworkData = {
                    userId: userId,
                    courseId: courseId,
                    courseName: course.name || "Unknown Course",
                    homeworkLink: document.getElementById('homeworkLink').value,
                    status: document.getElementById('homeworkStatus').value,
                    submittedAt: new Date(document.getElementById('homeworkDate').value).toISOString(),
                    rewardAmount: course.homeworkReward || 0
                };

                database.ref('homeworkSubmissions').push(homeworkData)
                    .then(() => {
                        logAdminActivity('Manual Homework Added', { userId: userId, courseId: courseId });
                        alert('হোমওয়ার্ক রেকর্ড সফলভাবে যোগ করা হয়েছে!');
                        closeModal('homeworkModal');
                    })
                    .catch(error => alert('ত্রুটি: ' + error.message));
            }
            
            function listenToFirebaseData() {
                database.ref("users").on("value", (t => { allUsers = t.val() || {}; applyUserFilters(); updateDashboard(); renderUserGrowthChart(); calculateAdvancedAnalytics(); renderCertificateTable(); renderSupportTicketsTable(); renderReferralAndMentorTables();}));
                database.ref("courses").on("value", (t => { allCourses = t.val() || {}; applyCourseFilters(); updateDashboard(); calculateAdvancedAnalytics(); renderQnaTable(); populateCourseSelect();}));
                database.ref("courseCategories").on("value", (t => { allCategories = t.val() || {}; renderCategoryTable(); }));
                database.ref("liveClasses").on("value", (snapshot) => { allLiveClasses = snapshot.val() || {}; renderLiveClassTable(); });
                database.ref('siteContent/gamificationSettings').on('value', (snapshot) => {
                     const settings = snapshot.val() || {};
                     document.getElementById('pointsPerLesson').value = settings.pointsPerLesson || '';
                     document.getElementById('pointsPerQuiz').value = settings.pointsPerQuiz || '';
                     renderBadgesTable(settings.badges);
                });
                database.ref('siteContent/announcement').on('value', (snapshot) => { const data = snapshot.val(); if (data) { document.getElementById('announcementTitle').value = data.title || ''; document.getElementById('announcementMessage').value = data.message || ''; document.getElementById('announcementStatus').value = data.status || 'inactive'; } });
                database.ref("earnings").on("value", (t => { allEarnings = t.val() || {}, renderEarningsTable(), updateDashboard() }));
                database.ref("projects").on("value", (t => { allProjects = t.val() || {}, renderProjectTable() }));
                database.ref("blogPosts").on("value", (t => { allBlogPosts = t.val() || {}, renderBlogTable() }));
                database.ref("siteContent").on("value", (t => { const e = t.val() || {}; allFeatures = e.features || {}, renderFeaturesTable(), renderSiteContentForms(e) }));
                database.ref("footerLinks").on("value", (t => { allFooterLinks = t.val() || {}, renderFooterLinksTable() }));
                database.ref("navigationMenu").on("value", (t => { allMenus = t.val() || {}, renderMenuTable() }));
                database.ref("subAdminRoles").on("value", (t => { allRoles = t.val() || {}, renderRoleTable(); renderMentorRoleSettings(); renderSupportTicketsTable(); }));
                database.ref("contacts").on("value", (t => { allContactMessages = t.val() || {}, renderContactMessagesTable() }));
                database.ref("payments").on("value", (t => { allPayments = t.val() || {}; applyPaymentFilters(); calculateAdvancedAnalytics(); }));
                database.ref("supportTickets").on("value", (t => { allSupportTickets = t.val() || {}, renderSupportTicketsTable() }));
                database.ref("courseReviews").on("value", (t => { allReviews = t.val() || {}, renderReviewsTableWithApproval() }));
                database.ref("coupons").on("value", (t => { allCoupons = t.val() || {}, renderCouponTable() }));
                database.ref("notifications").on("value", (t => { allNotifications = t.val() || {}, renderSentNotificationsTable() }));
                database.ref("workshops/main_workshop").on("value", (snapshot) => { const workshopData = snapshot.val(); if (workshopData) { document.getElementById("workshopTitle").value = workshopData.title || ""; document.getElementById("workshopDate").value = workshopData.date || ""; document.getElementById("workshopDescription").value = workshopData.description || ""; document.getElementById("workshopRegLink").value = workshopData.regLink || ""; document.getElementById("workshopStatus").value = workshopData.status || "inactive"; } });
                database.ref("homeworkSubmissions").on("value", (t => { allHomework = t.val() || {}; applyHomeworkFilters(); }));
                database.ref("withdrawalRequests").on("value", (t => { allWithdrawals = t.val() || {}; renderWithdrawalRequestsTable(); }));
                database.ref("forum_posts").on("value", (t => { renderForumPostsTable(t.val() || {}); }));
                database.ref("balance_logs").on("value", (t => { allBalanceLogs = t.val() || {}; renderBalanceLogsTable();}));
                database.ref("countryCodes").on("value", (t => { allCountryCodes = t.val() || {}; renderCountryCodeTable(); }));
                database.ref("adminActivityLogs").on("value", (t => { allActivityLogs = t.val() || {}; renderActivityLogTable(); }));
            }
            
            // ================== USER PAGINATION ==================
            function applyUserFilters() { const searchTerm = document.getElementById('userSearchInput').value.toLowerCase(); const statusFilter = document.getElementById('userStatusFilter').value; filteredUserKeys = Object.keys(allUsers).filter(userId => { const user = allUsers[userId]; if (!user) return false; const nameMatch = (user.name || '').toLowerCase().includes(searchTerm); const emailMatch = (user.email || '').toLowerCase().includes(searchTerm); const statusMatch = (statusFilter === 'all' || user.status === statusFilter); return (nameMatch || emailMatch) && statusMatch; }); userCurrentPage = 1; renderPaginatedUsers(); }
            function renderPaginatedUsers() { const startIndex = (userCurrentPage - 1) * usersPerPage; const endIndex = startIndex + usersPerPage; const userKeysToShow = filteredUserKeys.slice(startIndex, endIndex); const usersToRender = {}; userKeysToShow.forEach(key => { usersToRender[key] = allUsers[key]; }); renderUserTable(usersToRender); renderUserPaginationControls(); }
            function renderUserPaginationControls() { const container = document.getElementById('userPaginationControls'); const totalPages = Math.ceil(filteredUserKeys.length / usersPerPage); if (totalPages <= 1) { container.innerHTML = ''; return; } container.innerHTML = `<button id="prevUserPage" ${userCurrentPage === 1 ? 'disabled' : ''}>Previous</button><span>Page ${userCurrentPage} of ${totalPages}</span><button id="nextUserPage" ${userCurrentPage === totalPages ? 'disabled' : ''}>Next</button>`; document.getElementById('prevUserPage')?.addEventListener('click', () => { if (userCurrentPage > 1) { userCurrentPage--; renderPaginatedUsers(); } }); document.getElementById('nextUserPage')?.addEventListener('click', () => { if (userCurrentPage < totalPages) { userCurrentPage++; renderPaginatedUsers(); } }); }
            
            // ================== COURSE PAGINATION & SORTING ==================
            function applyCourseFilters() { 
                filteredCourseKeys = Object.keys(allCourses); 
                // NEW: Sorting courses by the 'order' property
                filteredCourseKeys.sort((a, b) => {
                    const orderA = allCourses[a].order || 0;
                    const orderB = allCourses[b].order || 0;
                    return orderA - orderB;
                });
                courseCurrentPage = 1; 
                renderPaginatedCourses(); 
            }
            function renderPaginatedCourses() { const startIndex = (courseCurrentPage - 1) * coursesPerPage; const endIndex = startIndex + coursesPerPage; const courseKeysToShow = filteredCourseKeys.slice(startIndex, endIndex); const coursesToRender = {}; courseKeysToShow.forEach(key => { coursesToRender[key] = allCourses[key]; }); renderCourseTable(coursesToRender); renderCoursePaginationControls(); }
            function renderCoursePaginationControls() { const container = document.getElementById('coursePaginationControls'); const totalPages = Math.ceil(filteredCourseKeys.length / coursesPerPage); if (totalPages <= 1) { container.innerHTML = ''; return; } container.innerHTML = `<button ${courseCurrentPage === 1 ? 'disabled' : ''} onclick="changeCoursePage(-1)">Previous</button><span>Page ${courseCurrentPage} of ${totalPages}</span><button ${courseCurrentPage === totalPages ? 'disabled' : ''} onclick="changeCoursePage(1)">Next</button>`; }
            window.changeCoursePage = function(change) { courseCurrentPage += change; renderPaginatedCourses(); }

            // ================== PAYMENT PAGINATION ==================
            function applyPaymentFilters() { filteredPaymentKeys = Object.keys(allPayments).sort((a, b) => new Date(allPayments[b].date) - new Date(allPayments[a].date)); paymentCurrentPage = 1; renderPaginatedPayments(); }
            function renderPaginatedPayments() { const startIndex = (paymentCurrentPage - 1) * paymentsPerPage; const endIndex = startIndex + paymentsPerPage; const paymentKeysToShow = filteredPaymentKeys.slice(startIndex, endIndex); const paymentsToRender = {}; paymentKeysToShow.forEach(key => { paymentsToRender[key] = allPayments[key]; }); renderPaymentHistoryTable(paymentsToRender); renderPaymentPaginationControls(); }
            function renderPaymentPaginationControls() { const container = document.getElementById('paymentPaginationControls'); const totalPages = Math.ceil(filteredPaymentKeys.length / paymentsPerPage); if (totalPages <= 1) { container.innerHTML = ''; return; } container.innerHTML = `<button ${paymentCurrentPage === 1 ? 'disabled' : ''} onclick="changePaymentPage(-1)">Previous</button><span>Page ${paymentCurrentPage} of ${totalPages}</span><button ${paymentCurrentPage === totalPages ? 'disabled' : ''} onclick="changePaymentPage(1)">Next</button>`; }
            window.changePaymentPage = function(change) { paymentCurrentPage += change; renderPaginatedPayments(); }

            // ================== HOMEWORK PAGINATION ==================
            function applyHomeworkFilters() { filteredHomeworkKeys = Object.keys(allHomework).sort((a,b) => new Date(allHomework[b].submittedAt) - new Date(allHomework[a].submittedAt)); homeworkCurrentPage = 1; renderPaginatedHomeworks(); }
            function renderPaginatedHomeworks() { const startIndex = (homeworkCurrentPage - 1) * homeworksPerPage; const endIndex = startIndex + homeworksPerPage; const homeworkKeysToShow = filteredHomeworkKeys.slice(startIndex, endIndex); const homeworksToRender = {}; homeworkKeysToShow.forEach(key => { homeworksToRender[key] = allHomework[key]; }); renderHomeworkReviewTable(homeworksToRender); renderHomeworkPaginationControls(); }
            function renderHomeworkPaginationControls() { const container = document.getElementById('homeworkPaginationControls'); const totalPages = Math.ceil(filteredHomeworkKeys.length / homeworksPerPage); if (totalPages <= 1) { container.innerHTML = ''; return; } container.innerHTML = `<button ${homeworkCurrentPage === 1 ? 'disabled' : ''} onclick="changeHomeworkPage(-1)">Previous</button><span>Page ${homeworkCurrentPage} of ${totalPages}</span><button ${homeworkCurrentPage === totalPages ? 'disabled' : ''} onclick="changeHomeworkPage(1)">Next</button>`; }
            window.changeHomeworkPage = function(change) { homeworkCurrentPage += change; renderPaginatedHomeworks(); }


            function renderUserTable(usersToRender) {
                const t = document.getElementById("userTableBody");
                t.innerHTML = "";
                for (const e in usersToRender) {
                    const n = usersToRender[e];
                    if (!n) continue;
                    const profilePic = n.profilePictureUrl ? `<img src="${n.profilePictureUrl}" width="40" height="40" style="border-radius: 50%; object-fit: cover;">` : 'N/A';
                    t.innerHTML += `<tr>
                        <td><input type="checkbox" class="user-checkbox" data-user-id="${e}"></td>
                        <td>${profilePic}</td>
                        <td>${n.name || 'N/A'}</td><td>${n.email || 'N/A'}</td>
                        <td>${(n.balance || 0).toLocaleString('bn-BD')}</td>
                        <td><span class="status ${n.status}">${n.status}</span></td>
                        <td>
                            ${n.status === 'pending' ? `<button class="action-btn" style="background-color: var(--success-color);" onclick="activateUser('${e}')">Activate</button>` : ''}
                            <button class="action-btn edit-btn" onclick="editUser('${e}')">সম্পাদনা</button>
                            <button class="action-btn" style="background-color: #d35400;" onclick="resetUserPassword('${e}')">পাসওয়ার্ড রিসেট</button>
                            <button class="action-btn enroll-btn" onclick="openEnrollModal('${e}')">Enroll</button>
                            <button class="action-btn" style="background-color: #8e44ad;" onclick="openManualBadgeModal('${e}')">Award Badge</button>
                            <button class="action-btn progress-btn" onclick="viewUserProgress('${e}')">Progress</button>
                            <button class="action-btn delete-btn" onclick="deleteData('users/${e}', {userId: e, email: n.email})">মুছুন</button>
                        </td></tr>`;
                }
            }

            window.editUser = function(t) {
                const e = allUsers[t];
                if (e) {
                    document.getElementById("userId").value = t; 
                    document.getElementById("userName").value = e.name; 
                    document.getElementById("userEmail").value = e.email;
                    document.getElementById("userProfilePicUrl").value = e.profilePictureUrl || '';
                    document.getElementById("userStatus").value = e.status; 
                    document.getElementById("userBalance").value = e.balance || 0; 
                    document.getElementById("userRole").value = e.role || '';
                    document.getElementById("userCountryCode").value = e.countryCode || '';
                    document.getElementById("userWhatsapp").value = e.whatsapp || '';
                    document.getElementById("userPoints").value = e.gamification ? e.gamification.points : 0;
                    document.getElementById("balanceReason").value = '';
                    openModal("userModal", "ব্যবহারকারী সম্পাদনা করুন", "userForm");
                }
            }

            window.resetUserPassword = function(userId) { const user = allUsers[userId]; if (!user) return; if (confirm(`আপনি কি নিশ্চিতভাবে ${user.name} (${user.email}) এর জন্য পাসওয়ার্ড রিসেট ইমেইল পাঠাতে চান?`)) { auth.sendPasswordResetEmail(user.email).then(() => { logAdminActivity('Password Reset', {userId: userId, email: user.email}); alert(`পাসওয়ার্ড রিসেট ইমেইল সফলভাবে ${user.email}-এ পাঠানো হয়েছে।`); }).catch((error) => { alert("ত্রুটি: " + error.message); }); } }
            
            function renderCertificateTable() { const tbody = document.getElementById('certificateTableBody'); tbody.innerHTML = ''; for (const userId in allUsers) { const user = allUsers[userId]; if (user.completedCourses) { for (const courseId in user.completedCourses) { const completionData = user.completedCourses[courseId]; tbody.innerHTML += `<tr> <td>${user.name}</td> <td>${completionData.courseName}</td> <td>${new Date(completionData.completionDate).toLocaleDateString('bn-BD')}</td> <td><button class="action-btn content-btn" onclick="generateCertificatePreview('${user.name}', '${completionData.courseName}')">সার্টিফিকেট দেখুন</button></td> </tr>`; } } } }
            
            function handleDashboardAnnouncementSave(event) {
                event.preventDefault();
                const announcementData = {
                    text: document.getElementById('dashboardAnnouncementText').value,
                    status: document.getElementById('dashboardAnnouncementStatus').value
                };
                database.ref('siteContent/dashboardAnnouncement').set(announcementData)
                    .then(() => {
                        logAdminActivity('Dashboard Announcement Updated');
                        alert('ড্যাশবোর্ড অ্যানাউন্সমেন্ট সফলভাবে সেভ হয়েছে!');
                    })
                    .catch(err => alert('ত্রুটি: ' + err.message));
            }

            function handleGlobalContentSave(event) {
                event.preventDefault();
                const blogFooterText = document.getElementById('blogFooterText').value;
                database.ref('siteContent/globalContent').update({ blogFooterText: blogFooterText })
                    .then(() => {
                        logAdminActivity('Global Content Updated');
                        alert('গ্লোবাল কনটেন্ট সফলভাবে সেভ হয়েছে!');
                    })
                    .catch(err => alert('ত্রুটি: ' + err.message));
            }

            function setupEventListeners() {
                document.getElementById("dashboardAnnouncementForm").addEventListener("submit", handleDashboardAnnouncementSave);
                document.getElementById("globalContentForm").addEventListener("submit", handleGlobalContentSave);
                document.getElementById("countryCodeForm").addEventListener("submit", handleCountryCodeForm);
                document.getElementById("manualBadgeForm").addEventListener("submit", handleManualBadgeAward);

                document.getElementById("userForm").addEventListener("submit", (function(t) {
                    t.preventDefault();
                    const userId = document.getElementById("userId").value;
                    const newBalance = parseFloat(document.getElementById("userBalance").value) || 0;
                    const reason = document.getElementById("balanceReason").value.trim();
                    const existingUser = allUsers[userId] || {};
                    const oldBalance = existingUser.balance || 0;

                    const existingGamification = existingUser.gamification || { points: 0, badges: {} };
                    const userData = {
                        ...existingUser,
                        name: document.getElementById("userName").value,
                        email: document.getElementById("userEmail").value,
                        profilePictureUrl: document.getElementById("userProfilePicUrl").value,
                        status: document.getElementById("userStatus").value,
                        balance: newBalance,
                        role: document.getElementById("userRole").value || null,
                        countryCode: document.getElementById("userCountryCode").value || null,
                        whatsapp: document.getElementById("userWhatsapp").value || null,
                        regDate: userId ? existingUser.regDate : (new Date).toISOString(),
                        gamification: { ...existingGamification, points: parseInt(document.getElementById("userPoints").value) || 0 }
                    };

                    if (newBalance !== oldBalance) {
                        const logData = { userId: userId, oldBalance: oldBalance, newBalance: newBalance, reason: reason || 'No reason provided' };
                        if (reason) { // Log to balance_logs only if reason is given
                            const logEntry = { userId: userId, adminId: auth.currentUser.uid, adminEmail: auth.currentUser.email, userName: userData.name, reason: reason, oldBalance: oldBalance, newBalance: newBalance, timestamp: new Date().toISOString() };
                            database.ref('balance_logs').push(logEntry);
                        }
                        logAdminActivity('User Balance Changed', logData);
                    }

                    (userId ? database.ref("users/" + userId).set(userData) : database.ref("users").push(userData))
                        .then(() => {
                            logAdminActivity('User Data Updated', { userId: userId });
                            closeModal("userModal");
                        });
                }));
                
                document.getElementById("createUserForm").addEventListener("submit", handleCreateUser);
                document.getElementById("paymentForm").addEventListener("submit", handleManualPayment);
                document.getElementById("homeworkForm").addEventListener("submit", handleManualHomework);
                document.getElementById("userSearchInput").addEventListener("keyup", applyUserFilters);
                document.getElementById("userStatusFilter").addEventListener("change", applyUserFilters);
                document.getElementById("mentorRolesForm").addEventListener("submit", handleMentorRoleSave);
                document.getElementById("categoryForm").addEventListener("submit", handleCategoryForm);
                document.getElementById("selectAllUsersCheckbox").addEventListener('change', (e) => {
                    document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                        checkbox.checked = e.target.checked;
                    });
                });
                document.getElementById("applyBulkActionButton").addEventListener('click', applyBulkAction);

                document.getElementById("liveClassForm").addEventListener("submit", function(e){ e.preventDefault(); const data = { title: document.getElementById('liveClassTitle').value, teacher: document.getElementById('liveClassTeacher').value, url: document.getElementById('liveClassUrl').value, dateTime: document.getElementById('liveClassDateTime').value, description: document.getElementById('liveClassDesc').value, }; database.ref('liveClasses').push(data).then(() => { logAdminActivity('Live Class Created', { title: data.title }); alert('লাইভ ক্লাস সফলভাবে যুক্ত হয়েছে!'); this.reset(); }); });
                document.getElementById("gamificationForm").addEventListener("submit", function(e){ e.preventDefault(); const data = { pointsPerLesson: parseInt(document.getElementById('pointsPerLesson').value) || 0, pointsPerQuiz: parseInt(document.getElementById('pointsPerQuiz').value) || 0, }; database.ref('siteContent/gamificationSettings').update(data).then(() => { logAdminActivity('Gamification Settings Updated'); alert('পয়েন্ট সেটিংস সেভ হয়েছে!'); }); });
                document.getElementById("badgeForm").addEventListener("submit", function(e){ e.preventDefault(); const badgeId = document.getElementById("badgeId").value; const badgeData = { name: document.getElementById('badgeName').value, icon: document.getElementById('badgeIcon').value, type: document.getElementById('badgeType').value, value: parseInt(document.getElementById('badgeValue').value) }; const ref = badgeId ? database.ref(`siteContent/gamificationSettings/badges/${badgeId}`) : database.ref('siteContent/gamificationSettings/badges').push(); ref.set(badgeData).then(() => { logAdminActivity('Badge Saved', { badgeId: badgeId || ref.key, name: badgeData.name }); alert('ব্যাজ সেভ হয়েছে!'); closeModal('badgeModal'); }); });
                document.getElementById("groupNotificationForm").addEventListener("submit", handleGroupNotification);
                
                document.getElementById("settingsForm").addEventListener("submit", (function(t) {
                    t.preventDefault();
                    
                    const settingsData = {
                        title: document.getElementById("siteTitle").value,
                        logoUrl: document.getElementById("logoUrl").value,
                        copyrightText: document.getElementById("copyrightText").value,
                        bannerImageUrl: document.getElementById("bannerImageUrl").value,
                        aboutImageUrl: document.getElementById("aboutImageUrl").value,
                        projectsImageUrl: document.getElementById("projectsImageUrl").value,
                        allowRegistration: document.getElementById("allowRegistration").value === 'true',
                        mainWhatsappLink: document.getElementById("mainWhatsappLink").value
                    };
                    database.ref("siteContent/settings").update(settingsData);

                    database.ref("siteContent/banner").update({ text: document.getElementById("bannerText").value });
                    database.ref("siteContent/aboutAdmin").update({ text: document.getElementById("aboutAdminText").value });

                    database.ref("siteContent/referralSettings").update({
                        newUserBonus: parseFloat(document.getElementById('newUserBonus').value) || 0,
                        referrerBonus: parseFloat(document.getElementById('referrerBonus').value) || 0,
                        mentorReferrerBonus: parseFloat(document.getElementById('mentorReferrerBonus').value) || 0,
                    });
                    database.ref("siteContent/contactInfo").update({ email: document.getElementById("contactEmail").value, phone: document.getElementById("contactPhone").value, address: document.getElementById("contactAddress").value, footerDescription: document.getElementById("footerDescription").value });
                    database.ref("siteContent/developerCredit").update({ name: document.getElementById("developerName").value, url: document.getElementById("developerUrl").value });
                    database.ref("siteContent/theme").update({ primaryColor: document.getElementById("primaryColor").value, secondaryColor: document.getElementById("secondaryColor").value });
                    database.ref("siteContent/announcement").set({ title: document.getElementById('announcementTitle').value, message: document.getElementById('announcementMessage').value, status: document.getElementById('announcementStatus').value });
                    
                    logAdminActivity('Website Settings Updated');
                    alert("সেটিংস সফলভাবে সেভ করা হয়েছে!");
                }));
                
                document.getElementById("addQuestionForm").addEventListener("submit", function(e) { e.preventDefault(); const text = document.getElementById('newQuestionText').value; const options = Array.from(document.querySelectorAll('.quiz-option')).map(i => i.value).filter(Boolean); const correct = parseInt(document.getElementById('newCorrectAnswer').value); if (text && options.length >= 2 && correct > 0 && correct <= options.length) { const questionData = { text, options, correct }; database.ref(`courses/${currentEditingCourseId}/quiz`).push(questionData) .then(() => { this.reset(); renderQuizQuestions(); }); } else { alert('Please fill the form correctly.'); } });
                document.getElementById("courseForm").addEventListener("submit", (function(t) {
                    t.preventDefault();
                    const e = document.getElementById("courseId").value;
                    let n = {
                        name: document.getElementById("courseName").value,
                        category: document.getElementById("courseCategory").value,
                        price: parseInt(document.getElementById("coursePrice").value) || 0,
                        order: parseInt(document.getElementById("courseOrder").value) || 0, // NEW: Saving order
                        homeworkReward: parseInt(document.getElementById("courseHomeworkReward").value) || 0,
                        homeworkLimit: parseInt(document.getElementById("courseHomeworkLimit").value) || 0,
                        imageURL: document.getElementById("courseImageURL").value,
                        whatsappLink: document.getElementById("courseWhatsappLink").value, 
                        trailerUrl: document.getElementById("courseTrailerURL").value,
                        passMark: parseInt(document.getElementById("coursePassMark").value) || 50,
                        description: document.getElementById("courseDescription").value,
                        status: document.getElementById("courseStatus").value
                    };
                    if(e && allCourses[e]) { n = {...allCourses[e], ...n}; }
                    (e ? database.ref("courses/" + e).set(n) : database.ref("courses").push(n)).then((() => {
                        logAdminActivity(e ? 'Course Updated' : 'Course Created', { courseId: e || 'new', name: n.name });
                        closeModal("courseModal");
                    }));
                })); 
                document.getElementById("projectForm").addEventListener("submit", (function(t) { t.preventDefault(); const e = document.getElementById("projectId").value, n = { title: document.getElementById("projectTitle").value, link: document.getElementById("projectLink").value }; (e ? database.ref("projects/" + e) : database.ref("projects").push()).set(n).then((() => closeModal("projectModal"))) })); 
                document.getElementById("blogForm").addEventListener("submit", (function(t) { t.preventDefault(); const e = document.getElementById("blogId").value, n = { title: document.getElementById("blogTitle").value, imageUrl: document.getElementById("blogImageUrl").value, content: document.getElementById("blogContent").value, status: document.getElementById("blogStatus").value, date: e && allBlogPosts[e] ? allBlogPosts[e].date : (new Date).toISOString() }; (e ? database.ref("blogPosts/" + e) : database.ref("blogPosts").push()).set(n).then((() => closeModal("blogModal"))) })); 
                document.getElementById("footerLinkForm").addEventListener("submit", (function(t) { t.preventDefault(); const e = document.getElementById("footerLinkId").value, n = { name: document.getElementById("footerLinkName").value, url: document.getElementById("footerLinkUrl").value }; (e ? database.ref("footerLinks/" + e) : database.ref("footerLinks").push()).set(n).then((() => closeModal("footerLinkModal"))) })); 
                document.getElementById("sectionTitlesForm").addEventListener("submit", (function(t) { t.preventDefault(), database.ref("siteContent/sectionTitles").update({ featuresSubtitle: document.getElementById("featuresSubtitle").value, featuresMainTitle: document.getElementById("featuresMainTitle").value, coursesSubtitle: document.getElementById("coursesSubtitle").value, coursesMainTitle: document.getElementById("coursesMainTitle").value, projectsSubtitle: document.getElementById("projectsSubtitle").value, projectsMainTitle: document.getElementById("projectsMainTitle").value }), alert("শিরোনাম সফলভাবে সেভ করা হয়েছে!") })); 
                document.getElementById("introFooterForm").addEventListener("submit", (function(t) { t.preventDefault(), database.ref("siteContent/introFooter").set([{ image: document.getElementById("introItem1Image").value, title: document.getElementById("introItem1Title").value }, { image: document.getElementById("introItem2Image").value, title: document.getElementById("introItem2Title").value }, { image: document.getElementById("introItem3Image").value, title: document.getElementById("introItem3Title").value }]), alert("ইন্ট্রো ফুটার আইটেম সফলভাবে সেভ করা হয়েছে!") })); 
                document.getElementById("socialLinksForm").addEventListener("submit", (function(t) { t.preventDefault(), database.ref("siteContent/socialLinks").update({ facebook: document.getElementById("facebookLink").value, telegram: document.getElementById("telegramLink").value, twitter: document.getElementById("twitterLink").value, youtube: document.getElementById("youtubeLink").value }), alert("সোশ্যাল লিংক সফলভাবে সেভ করা হয়েছে!") })); 
                document.getElementById("menuForm").addEventListener("submit", (function(t) { t.preventDefault(); const e = document.getElementById("menuId").value, n = { name: document.getElementById("menuName").value, url: document.getElementById("menuUrl").value, order: parseInt(document.getElementById("menuOrder").value) }; (e ? database.ref("navigationMenu/" + e) : database.ref("navigationMenu").push()).set(n).then((() => closeModal("menuModal"))).catch((t => alert(t.message))) })); 
                
                document.getElementById("roleForm").addEventListener("submit", (function(t) { 
                    t.preventDefault(); 
                    const e = document.getElementById("roleId").value;
                    const permissions = {};
                    document.querySelectorAll('.permissions-grid input[type="checkbox"]').forEach(checkbox => {
                        if (checkbox.checked) {
                            permissions[checkbox.value] = true;
                        }
                    });
                    const n = { 
                        name: document.getElementById("roleName").value, 
                        value: document.getElementById("roleValue").value,
                        permissions: permissions
                    }; 
                    (e ? database.ref("subAdminRoles/" + e) : database.ref("subAdminRoles").push()).set(n).then((() => closeModal("roleModal"))).catch((t => alert(t.message))) 
                })); 

                document.getElementById("featureForm").addEventListener("submit", (function(t) { t.preventDefault(); const e = document.getElementById("featureId").value, n = { image: document.getElementById("featureImage").value, title: document.getElementById("featureTitle").value, desc: document.getElementById("featureDesc").value }; (e ? database.ref("siteContent/features/" + e) : database.ref("siteContent/features").push()).set(n).then((() => closeModal("featureModal"))).catch((t => alert(t.message))) })); 
                document.getElementById("seoForm").addEventListener("submit", function(e) { e.preventDefault(); database.ref("siteContent/seo").update({ metaTitle: document.getElementById("metaTitle").value, metaDescription: document.getElementById("metaDescription").value }).then(() => alert("SEO তথ্য সফলভাবে সেভ করা হয়েছে!")); }); 
                document.getElementById("languageForm").addEventListener("submit", function(e) {
                     e.preventDefault();
                     database.ref("siteContent/language").update({ signInButton: document.getElementById("lang-signInButton").value, signUpButton: document.getElementById("lang-signUpButton").value, dashboardButton: document.getElementById("lang-dashboardButton").value, signOutButton: document.getElementById("lang-signOutButton").value, adminLoginButton: document.getElementById("lang-adminLoginButton").value, subadminLoginButton: document.getElementById("lang-subadminLoginButton").value, contactFormMainTitle: document.getElementById("lang-contactFormMainTitle").value, contactSubmitButton: document.getElementById("lang-contactSubmitButton").value, enrollNowButton: document.getElementById("lang-enrollNowButton").value, signInTitle: document.getElementById("lang-signInTitle").value, signUpTitle: document.getElementById("lang-signUpTitle").value, forgotPasswordLink: document.getElementById("lang-forgotPasswordLink").value });
                     database.ref("siteContent/dashboardLabels").update({ overview: document.getElementById("lang-tabOverview").value, myCourses: document.getElementById("lang-tabMyCourses").value, notifications: document.getElementById("lang-tabNotifications").value, achievements: document.getElementById("lang-tabAchievements").value, leaderboard: document.getElementById("lang-tabLeaderboard").value, profile: document.getElementById("lang-tabProfile").value, payments: document.getElementById("lang-tabPayments").value });
                     database.ref("siteContent/sectionTitles").update({
                        liveClassSubtitle: document.getElementById("title-liveClassSubtitle").value,
                        liveClassMainTitle: document.getElementById("title-liveClassMainTitle").value,
                        communitySubtitle: document.getElementById("title-communitySubtitle").value,
                        communityMainTitle: document.getElementById("title-communityMainTitle").value,
                        workshopSubtitle: document.getElementById("title-workshopSubtitle").value,
                        workshopMainTitle: document.getElementById("title-workshopMainTitle").value
                     }).then(() => alert("টেক্সট সফলভাবে সেভ করা হয়েছে!"));
                }); 
                document.getElementById("enrollForm").addEventListener("submit", function(e) { e.preventDefault(); const userId = document.getElementById('enrollUserId').value; const courseId = document.getElementById('enrollCourseSelect').value; if (!userId || !courseId) { alert('Please select a course.'); return; } const enrollmentData = { courseId: courseId, enrollmentDate: new Date().toISOString(), purchasePrice: 0 }; database.ref(`users/${userId}/enrolledCourses`).push(enrollmentData) .then(() => { database.ref('payments').push({ userId, courseId, amount: 0, transactionId: 'MANUAL_ENROLL', date: new Date().toISOString() }); alert('User enrolled successfully!'); closeModal('enrollModal'); }).catch(err => alert(err.message)); });
                document.getElementById("notificationForm").addEventListener("submit", function(e) { e.preventDefault(); const message = document.getElementById('notificationMessage').value; if (!message.trim()) { alert('Message cannot be empty.'); return; } database.ref('notifications').push({ message: message, timestamp: new Date().getTime() }).then(() => { logAdminActivity('Global Notification Sent'); alert('Notification sent to all users!'); this.reset(); }); });
                document.getElementById("couponForm").addEventListener("submit", function(e) { e.preventDefault(); const data = { code: document.getElementById('couponCode').value.toUpperCase(), type: document.getElementById('couponType').value, value: parseFloat(document.getElementById('couponValue').value), expiryDate: document.getElementById('couponExpiry').value || null }; if(!data.code || !data.value) { alert('Code and Value are required.'); return; } database.ref('coupons').push(data).then(() => { logAdminActivity('Coupon Created', { code: data.code }); alert('Coupon saved successfully!'); closeModal('couponModal'); }); });
                document.getElementById("workshopForm").addEventListener("submit", function(e) { e.preventDefault(); const workshopId = document.getElementById("workshopId").value; const data = { title: document.getElementById("workshopTitle").value, date: document.getElementById("workshopDate").value, description: document.getElementById("workshopDescription").value, regLink: document.getElementById("workshopRegLink").value, status: document.getElementById("workshopStatus").value }; database.ref(`workshops/${workshopId}`).set(data) .then(() => { logAdminActivity('Workshop Updated', { title: data.title }); alert("ওয়ার্কশপের তথ্য সফলভাবে সেভ করা হয়েছে!"); }) .catch(err => alert("Error: " + err.message)); });
                document.getElementById("addModuleForm").addEventListener('submit', function(e) { e.preventDefault(); const moduleName = document.getElementById('newModuleName').value; if (moduleName && currentEditingCourseId) { database.ref(`courses/${currentEditingCourseId}/modules`).push({ title: moduleName }).then(() => { document.getElementById('newModuleName').value = ''; }); } });
            }
            
            window.seedDatabaseWithInitialData = function() { 
                const confirmation1 = prompt("WARNING: This will overwrite existing data. Type 'PROCEED' to continue.");
                if (confirmation1 !== 'PROCEED') {
                    alert("Operation cancelled.");
                    return;
                }
                const confirmation2 = prompt("Are you absolutely sure? This action is irreversible. Type 'CONFIRM DELETE' to proceed.");
                if (confirmation2 !== 'CONFIRM DELETE') {
                    alert("Operation cancelled.");
                    return;
                }
                const user = auth.currentUser;
                const confirmation3 = prompt("Final confirmation. Please type your admin email to proceed.");
                if (confirmation3 !== user.email) {
                    alert("Incorrect email. Operation cancelled.");
                    return;
                }

                alert("Seeding data...");
                const courses = [ { name: "Photo Editing", image: "https://i.ibb.co/wZy4F5GY/Photo-Editing.jpg" }, { name: "Video Editing", image: "https://i.ibb.co/BS61VSm/Video-Editing.jpg" }, { name: "Lead Generation", image: "https://i.ibb.co/TqbVq1rL/Lead-Generation.jpg" }, { name: "Affiliated Marketing", image: "https://i.ibb.co/TxDRgjjS/Affiliate-Marketing.jpg" }, { name: "CPA Marketing", image: "https://i.ibb.co/JRddPyVK/CPA-Marketing.jpg" }, { name: "Social Marketing", image: "https://i.ibb.co/XfFWbrDd/Social-Marketing.jpg" }, { name: "Digital Marketing", image: "https://i.ibb.co/LdyFpy0R/Digital-Marketing.jpg" }, { name: "Products Sells and buy", image: "https://i.ibb.co/LD07Vn9R/Products-Sell-and-Buy.jpg" }, { name: "Data Entry", image: "https://i.ibb.co/11DVCZB/Data-Entry.jpg" }, { name: "Graphics Design", image: "https://i.ibb.co/5h7npzgv/Graphics-Design.jpg" }, { name: "Spoking English", image: "https://i.ibb.co/hJwBBnqP/Spoken-English.jpg" }, { name: "App Development", image: "https://i.ibb.co/ynm14PjM/App-Development.jpg" }, { name: "Website Development", image: "https://i.ibb.co/7tpC3sBH/Website-Development.jpg" }, { name: "Treading", image: "https://i.ibb.co/d492Tm5j/Trading.jpg" }, { name: "Crypto", image: "https://i.ibb.co/wFvWZ3Qq/Crypto.jpg" } ]; const subAdminRoles = [ "Photo Editing Teacher", "Team Leader", "Video Editing Teacher", "Trainer", "Counsellor", "Senior Counsellor", "Help-Line", "Social Marketing Teacher", "Web-Developer", "Selling Team", "Marketing Team", "Qualification Team", "Manager", "Controller", "Teacher", "Checker", "Senior Team Leader", "Senior Controller", "Counsellor Manager", "Marketing Manager" ]; const updates = {}; const coursesData = {}; courses.forEach(course => { const newCourseKey = database.ref().child('courses').push().key; coursesData[newCourseKey] = { name: course.name, imageURL: course.image, price: 1500, category: "Skill Development", description: `A comprehensive course on ${course.name}.`, status: "published" }; }); updates['/courses'] = coursesData; const rolesData = {}; subAdminRoles.forEach((role, index) => { const newRoleKey = database.ref().child('subAdminRoles').push().key; rolesData[newRoleKey] = { name: role, value: index + 1 }; }); updates['/subAdminRoles'] = rolesData; updates['/siteContent/settings/logoUrl'] = "https://i.ibb.co/jk2nT0LF/IMG-20251012-WA0006.jpg"; updates['/siteContent/settings/bannerImageUrl'] = "https://i.ibb.co/LzXmdd7g/Banner-Image.jpg"; updates['/siteContent/settings/aboutImageUrl'] = "https://i.ibb.co/PGbByrmD/About-Admin.jpg"; updates['/siteContent/banner/text'] = "আপনার দক্ষতার মাধ্যমে আয়ের জগতে স্বাগতম!"; updates['/siteContent/aboutAdmin/text'] = "আমরা একটি অভিজ্ঞ দল যারা আপনাকে ডিজিটাল বিশ্বের নতুন সব সুযোগের সাথে পরিচয় করিয়ে দিতে প্রতিশ্রুতিবদ্ধ। আমাদের লক্ষ্য হলো আপনাকে সঠিক জ্ঞান এবং দক্ষতার মাধ্যমে স্বাবলম্বী করে তোলা।"; database.ref().update(updates) .then(() => { logAdminActivity('Site Initialized with Sample Data'); alert("Site has been initialized with sample data successfully!"); }) .catch((error) => alert("An error occurred: " + error.message)); 
            }

            window.backupData = function() { 
                alert("মনোযোগ দিন: এই ব্যাকআপটি শুধুমাত্র ছোট ডেটাবেসের জন্য উপযুক্ত। আপনার সাইটে অনেক বেশি ব্যবহারকারী বা ডেটা থাকলে, ব্রাউজার ক্র্যাশ করতে পারে। নির্ভরযোগ্য ব্যাকআপের জন্য সর্বদা Firebase Console ব্যবহার করুন।");
                if(!confirm("আপনি কি ডাউনলোড চালিয়ে যেতে চান?")) return;
                const dataToBackup = {}; const paths = ['users', 'courses', 'payments', 'earnings', 'coupons', 'siteContent', 'subAdminRoles', 'navigationMenu', 'footerLinks']; let fetchedCount = 0; paths.forEach(path => { database.ref(path).once('value', snapshot => { dataToBackup[path] = snapshot.val(); fetchedCount++; if (fetchedCount === paths.length) { const jsonString = JSON.stringify(dataToBackup, null, 2); const blob = new Blob([jsonString], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `income-impact-backup-${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); } }); }); 
            }
            
            function renderUserGrowthChart() { const userValues = Object.values(allUsers); const monthlyData = {}; for (let i = 5; i >= 0; i--) { const d = new Date(); d.setMonth(d.getMonth() - i); const monthKey = `${d.getFullYear()}-${d.getMonth()}`; monthlyData[monthKey] = { label: d.toLocaleString('default', { month: 'short' }), count: 0 }; } userValues.forEach(user => { if (!user || !user.regDate) return; const regDate = new Date(user.regDate); const monthKey = `${regDate.getFullYear()}-${regDate.getMonth()}`; if (monthlyData[monthKey]) { monthlyData[monthKey].count++; } }); const labels = Object.values(monthlyData).map(m => m.label); const data = Object.values(monthlyData).map(m => m.count); const ctx = document.getElementById('userGrowthChart').getContext('2d'); if (userGrowthChartInstance) { userGrowthChartInstance.destroy(); } userGrowthChartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'New Users', data: data, borderColor: 'rgba(52, 152, 219, 1)', backgroundColor: 'rgba(52, 152, 219, 0.2)', fill: true, tension: 0.4 }] }, options: { responsive: true, scales: { y: { beginAtZero: true } } } }); }
            function updateDashboard() { const t = Object.values(allUsers), e = Object.values(allCourses); document.getElementById("totalUsers").textContent = t.length, document.getElementById("totalCourses").textContent = e.length; const l = Object.values(allPayments).reduce(((t, e) => t + (e.amount || 0)), 0); document.getElementById("totalEarnings").textContent = l.toLocaleString("bn-BD"); const s = t.filter((t => "active" === t.status)).length; document.getElementById("activeStudents").textContent = s }
            function renderCourseTable(coursesToRender) {
                const t = document.getElementById("courseTableBody");
                t.innerHTML = "";
                for (const e in coursesToRender) {
                    const n = coursesToRender[e];
                    // NEW: Added 'order' column display
                    t.innerHTML += `<tr><td>${n.name}</td><td>${n.category || 'N/A'}</td><td>${(n.price||0).toLocaleString("bn-BD")}</td>
                    <td>${n.homeworkReward || 0}</td>
                    <td>${n.order || 0}</td>
                    <td><span class="status ${n.status}">${n.status}</span></td>
                    <td>
                        <button class="action-btn" style="background-color: #27ae60;" onclick="openViewStudentsModal('${e}')">ছাত্র দেখুন</button>
                        <button class="action-btn edit-btn" onclick="editCourse('${e}')">সম্পাদনা</button>
                        <button class="action-btn content-btn" onclick="openCourseContentModal('${e}')">কনটেন্ট</button>
                        <button class="action-btn delete-btn" onclick="deleteData('courses/${e}', {courseId: e, name: n.name})">মুছুন</button>
                    </td></tr>`
                }
            }
            function renderPaymentHistoryTable(paymentsToRender) { const t = document.getElementById("paymentHistoryTableBody"); t.innerHTML = ""; for (const id in paymentsToRender) { const n = paymentsToRender[id]; const user = allUsers[n.userId] || {email: 'Unknown'}; const course = allCourses[n.courseId] || {name: 'Unknown'}; t.innerHTML += `<tr><td>${user.email}</td><td>${course.name}</td><td>${(n.amount||0).toLocaleString("bn-BD")}</td><td>${n.transactionId}</td><td>${new Date(n.date).toLocaleString("bn-BD")}</td></tr>` } }
            
            function renderSupportTicketsTable() {
                const t = document.getElementById("supportTicketsTableBody");
                t.innerHTML = "";
                if(Object.keys(allSupportTickets).length === 0) return;

                const subAdmins = Object.values(allUsers).filter(u => u.role && u.role.trim() !== '');
                const sortedTickets = Object.entries(allSupportTickets).sort((a,b) => new Date(b[1].timestamp) - new Date(a[1].timestamp));
                for (const [e, n] of sortedTickets) {
                    const user = allUsers[n.userId] || {email: 'Unknown'};

                    const priorityOptions = ['Low', 'Medium', 'High'].map(p => `<option value="${p}" ${n.priority === p ? 'selected' : ''}>${p}</option>`).join('');
                    const prioritySelect = `<select onchange="updateTicketPriority('${e}', this.value)">${priorityOptions}</select>`;
                    
                    let assigneeOptions = '<option value="">Unassigned</option>';
                    subAdmins.forEach(admin => {
                        assigneeOptions += `<option value="${admin.email}" ${n.assignedTo === admin.email ? 'selected' : ''}>${admin.name}</option>`;
                    });
                    assigneeSelect = `<select onchange="assignTicket('${e}', this.value)">${assigneeOptions}</select>`;

                    let actionButtons = `<button class="action-btn" style="background: #16a085;" onclick="replyToTicket('${e}')">Reply</button>`;
                    if (n.status === 'pending') {
                        actionButtons += `<button class="action-btn edit-btn" onclick="updateTicketStatus('${e}', 'resolved')">Mark Resolved</button>`;
                    }
                    actionButtons += `<button class="action-btn delete-btn" onclick="deleteData('supportTickets/${e}')">Delete</button>`;

                    t.innerHTML += `<tr>
                        <td>${user.name || user.email}</td>
                        <td>${n.subject}</td>
                        <td class="message-col">${n.message} ${n.reply ? `<br><strong>Reply:</strong> ${n.reply}` : ''}</td>
                        <td>${prioritySelect}</td>
                        <td>${assigneeSelect}</td>
                        <td><span class="status ${n.status}">${n.status}</span></td>
                        <td>${actionButtons}</td>
                    </tr>`;
                }
            }

            function renderReviewsTableWithApproval() { const t = document.getElementById("reviewsTableBody"); t.innerHTML = ""; for (const reviewId in allReviews) { const review = allReviews[reviewId]; const user = allUsers[review.userId] || {email: 'Unknown'}; const course = allCourses[review.courseId] || {name: 'Unknown'}; let actionButtons = ''; if (review.status === 'Pending') { actionButtons = ` <button class="action-btn" style="background-color: var(--success-color);" onclick="updateReviewStatus('${reviewId}', 'Approved')">Approve</button> <button class="action-btn" style="background-color: var(--danger-color);" onclick="updateReviewStatus('${reviewId}', 'Rejected')">Reject</button> `; } else { actionButtons = `<button class="action-btn delete-btn" onclick="deleteData('courseReviews/${reviewId}')">মুছুন</button>`; } t.innerHTML += ` <tr> <td>${course.name}</td> <td>${user.email}</td> <td>${'⭐'.repeat(review.rating)}</td> <td class="review-col">${review.review}</td> <td><span class="status ${review.status}">${review.status}</span></td> <td>${actionButtons}</td> </tr>`; } }
            function updateReviewStatus(reviewId, status) { database.ref(`courseReviews/${reviewId}`).update({ status: status }) .then(() => { logAdminActivity('Review Status Updated', { reviewId, status }); alert(`Review status updated to ${status}`); }) .catch(err => alert('Error updating status: ' + err.message)); }
            function renderQnaTable() { const tableBody = document.getElementById("qnaTableBody"); tableBody.innerHTML = ""; for (const courseId in allCourses) { const course = allCourses[courseId]; if (!course.modules) continue; for (const moduleId in course.modules) { const module = course.modules[moduleId]; if (!module.lessons) continue; for (const lessonId in module.lessons) { const lesson = module.lessons[lessonId]; if (!lesson.qna) continue; for (const qnaId in lesson.qna) { const qna = lesson.qna[qnaId]; const fullPath = `courses/${courseId}/modules/${moduleId}/lessons/${lessonId}/qna/${qnaId}`; let replyButton = qna.reply ? `<button class="action-btn edit-btn" onclick="replyToQuestion('${fullPath}')">Edit Reply</button>` : `<button class="action-btn" style="background-color: var(--success-color);" onclick="replyToQuestion('${fullPath}')">Reply</button>`; tableBody.innerHTML += ` <tr> <td>${course.name}</td> <td>${lesson.title}</td> <td>${qna.userName}</td> <td class="message-col">${qna.question}</td> <td> ${replyButton} <button class="action-btn delete-btn" onclick="deleteData('${fullPath}')">Delete</button> </td> </tr> `; } } } } }
            window.replyToQuestion = function(qnaPath) { const replyText = prompt("Please enter your reply:"); if (replyText) { const replyData = { text: replyText, timestamp: new Date().toISOString() }; database.ref(qnaPath).update({ reply: replyData }) .then(() => alert("Reply posted successfully!")) .catch(err => alert("Error posting reply: " + err.message)); } }
            function renderEarningsTable() { const t = document.getElementById("earningsTableBody"); t.innerHTML = ""; for (const e in allEarnings) { const n = allEarnings[e]; t.innerHTML += `<tr><td>TXN${(e||"").substring(e.length - 6)}</td><td>${n.userName}</td><td>${n.courseName}</td><td>${(n.amount||0).toLocaleString("bn-BD")}</td><td>${new Date(n.date).toLocaleDateString("bn-BD")}</td></tr>` } }
            function renderProjectTable() { const t = document.getElementById("projectTableBody"); t.innerHTML = ""; for (const e in allProjects) { const n = allProjects[e]; t.innerHTML += `<tr><td>${n.title}</td><td>${n.link}</td><td><button class="action-btn edit-btn" onclick="editProject('${e}')">সম্পাদনা</button><button class="action-btn delete-btn" onclick="deleteData('projects/${e}')">মুছুন</button></td></tr>` } }
            function renderBlogTable() { const t = document.getElementById("blogTableBody"); t.innerHTML = ""; for (const e in allBlogPosts) { const n = allBlogPosts[e]; t.innerHTML += `<tr><td>${n.title}</td><td><span class="status ${n.status}">${n.status}</span></td><td>${new Date(n.date).toLocaleDateString("bn-BD")}</td><td><button class="action-btn edit-btn" onclick="editBlogPost('${e}')">সম্পাদনা</button><button class="action-btn delete-btn" onclick="deleteData('blogPosts/${e}')">মুছুন</button></td></tr>` } }
            function renderFooterLinksTable() { const t = document.getElementById("footerLinksTableBody"); t.innerHTML = ""; for (const e in allFooterLinks) { const n = allFooterLinks[e]; t.innerHTML += `<tr><td>${n.name}</td><td>${n.url}</td><td><button class="action-btn edit-btn" onclick="editFooterLink('${e}')">সম্পাদনা</button><button class="action-btn delete-btn" onclick="deleteData('footerLinks/${e}')">মুছুন</button></td></tr>` } }
            function renderMenuTable() { const t = document.getElementById("menuTableBody"); t.innerHTML = ""; const e = Object.entries(allMenus).sort((([,t],[,e]) => t.order - e.order)); for (const [n, l] of e) t.innerHTML += `<tr><td>${l.name}</td><td>${l.url}</td><td>${l.order}</td><td><button class="action-btn edit-btn" onclick="editMenu('${n}')">সম্পাদনা</button><button class="action-btn delete-btn" onclick="deleteData('navigationMenu/${n}')">মুছুন</button></td></tr>` }
            function renderRoleTable() { const t = document.getElementById("roleTableBody"); t.innerHTML = ""; for (const e in allRoles) { const n = allRoles[e]; t.innerHTML += `<tr><td>${n.name}</td><td>${n.value}</td><td><button class="action-btn edit-btn" onclick="editRole('${e}')">সম্পাদনা</button><button class="action-btn delete-btn" onclick="deleteData('subAdminRoles/${e}')">মুছুন</button></td></tr>` } }
            function renderFeaturesTable() { const t = document.getElementById("featuresTableBody"); t.innerHTML = ""; for (const e in allFeatures) { const n = allFeatures[e]; t.innerHTML += `<tr><td>${n.image.substring(0,30)}...</td><td>${n.title}</td><td>${(n.desc||"").substring(0,40)}...</td><td><button class="action-btn edit-btn" onclick="editFeature('${e}')">সম্পাদনা</button><button class="action-btn delete-btn" onclick="deleteData('siteContent/features/${e}')">মুছুন</button></td></tr>` } }
            function renderContactMessagesTable() { const t = document.getElementById("contactMessagesTableBody"); t.innerHTML = ""; const sortedMessages = Object.entries(allContactMessages).sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp)); for (const [key, msg] of sortedMessages) { t.innerHTML += `<tr><td>${msg.name}</td><td>${msg.email}</td><td class="message-col">${msg.message}</td><td>${new Date(msg.timestamp).toLocaleString("bn-BD")}</td><td><button class="action-btn delete-btn" onclick="deleteData('contacts/${key}')">মুছুন</button></td></tr>`; } }
            function renderSiteContentForms(t) { 
                document.getElementById("dashboardAnnouncementText").value = t.dashboardAnnouncement?.text || ""; 
                document.getElementById("dashboardAnnouncementStatus").value = t.dashboardAnnouncement?.status || "inactive"; 
                document.getElementById("blogFooterText").value = t.globalContent?.blogFooterText || "";
                document.getElementById("mainWhatsappLink").value = t.settings?.mainWhatsappLink || "";
                if(t.referralSettings) {
                    document.getElementById('newUserBonus').value = t.referralSettings.newUserBonus || '';
                    document.getElementById('referrerBonus').value = t.referralSettings.referrerBonus || '';
                    document.getElementById('mentorReferrerBonus').value = t.referralSettings.mentorReferrerBonus || '';
                }

                document.getElementById("bannerText").value = t.banner?.text || ""; 
                document.getElementById("aboutAdminText").value = t.aboutAdmin?.text || ""; 
                document.getElementById("featuresSubtitle").value = t.sectionTitles?.featuresSubtitle || ""; 
                document.getElementById("featuresMainTitle").value = t.sectionTitles?.featuresMainTitle || ""; 
                document.getElementById("coursesSubtitle").value = t.sectionTitles?.coursesSubtitle || ""; 
                document.getElementById("coursesMainTitle").value = t.sectionTitles?.coursesMainTitle || ""; 
                document.getElementById("projectsSubtitle").value = t.sectionTitles?.projectsSubtitle || ""; 
                document.getElementById("projectsMainTitle").value = t.sectionTitles?.projectsMainTitle || ""; 
                document.getElementById("introItem1Image").value = t.introFooter?.[0]?.image || ""; 
                document.getElementById("introItem1Title").value = t.introFooter?.[0]?.title || ""; 
                document.getElementById("introItem2Image").value = t.introFooter?.[1]?.image || ""; 
                document.getElementById("introItem2Title").value = t.introFooter?.[1]?.title || ""; 
                document.getElementById("introItem3Image").value = t.introFooter?.[2]?.image || ""; 
                document.getElementById("introItem3Title").value = t.introFooter?.[2]?.title || ""; 
                document.getElementById("facebookLink").value = t.socialLinks?.facebook || ""; 
                document.getElementById("telegramLink").value = t.socialLinks?.telegram || ""; 
                document.getElementById("twitterLink").value = t.socialLinks?.twitter || ""; 
                document.getElementById("youtubeLink").value = t.socialLinks?.youtube || ""; 
                document.getElementById("siteTitle").value = t.settings?.title || ""; 
                document.getElementById("logoUrl").value = t.settings?.logoUrl || ""; 
                document.getElementById("copyrightText").value = t.settings?.copyrightText || ""; 
                document.getElementById("bannerImageUrl").value = t.settings?.bannerImageUrl || ""; 
                document.getElementById("aboutImageUrl").value = t.settings?.aboutImageUrl || ""; 
                document.getElementById("projectsImageUrl").value = t.settings?.projectsImageUrl || ""; 
                document.getElementById("contactEmail").value = t.contactInfo?.email || ""; 
                document.getElementById("contactPhone").value = t.contactInfo?.phone || ""; 
                document.getElementById("contactAddress").value = t.contactInfo?.address || ""; 
                document.getElementById("footerDescription").value = t.contactInfo?.footerDescription || ""; 
                document.getElementById("developerName").value = t.developerCredit?.name || ""; 
                document.getElementById("developerUrl").value = t.developerCredit?.url || ""; 
                document.getElementById("primaryColor").value = t.theme?.primaryColor || "#007BFF"; 
                document.getElementById("secondaryColor").value = t.theme?.secondaryColor || "#00C9A7"; 
                document.getElementById("metaTitle").value = t.seo?.metaTitle || ""; 
                document.getElementById("metaDescription").value = t.seo?.metaDescription || ""; 
                document.getElementById("allowRegistration").value = t.settings?.allowRegistration === false ? 'false' : 'true'; 
                
                const titles = t.sectionTitles || {};
                document.getElementById("title-liveClassSubtitle").value = titles.liveClassSubtitle || "লাইভ কার্যক্রম";
                document.getElementById("title-liveClassMainTitle").value = titles.liveClassMainTitle || "আমাদের আসন্ন লাইভ ক্লাস";
                document.getElementById("title-communitySubtitle").value = titles.communitySubtitle || "আলোচনা";
                document.getElementById("title-communityMainTitle").value = titles.communityMainTitle || "কমিউনিটি ফোরাম";
                document.getElementById("title-workshopSubtitle").value = titles.workshopSubtitle || "আমাদের কার্যক্রম";
                document.getElementById("title-workshopMainTitle").value = titles.workshopMainTitle || "আসন্ন ওয়ার্কশপ";

                const lang = t.language || {}; document.getElementById("lang-signInButton").value = lang.signInButton || "Sign In"; document.getElementById("lang-signUpButton").value = lang.signUpButton || "Sign Up"; document.getElementById("lang-dashboardButton").value = lang.dashboardButton || "My Dashboard"; document.getElementById("lang-signOutButton").value = lang.signOutButton || "Sign Out"; document.getElementById("lang-adminLoginButton").value = lang.adminLoginButton || "Admin Login"; document.getElementById("lang-subadminLoginButton").value = lang.subadminLoginButton || "Subadmin Login"; document.getElementById("lang-contactFormMainTitle").value = lang.contactFormMainTitle || "Contact Us"; document.getElementById("lang-contactSubmitButton").value = lang.contactSubmitButton || "Send Message"; document.getElementById("lang-enrollNowButton").value = lang.enrollNowButton || "Enroll Now"; document.getElementById("lang-signInTitle").value = lang.signInTitle || "Sign In"; document.getElementById("lang-signUpTitle").value = lang.signUpTitle || "Sign Up"; document.getElementById("lang-forgotPasswordLink").value = lang.forgotPasswordLink || "Forgot Password?"; const dashboardLabels = t.dashboardLabels || {}; document.getElementById("lang-tabOverview").value = dashboardLabels.overview || "Overview"; document.getElementById("lang-tabMyCourses").value = dashboardLabels.myCourses || "My Courses"; document.getElementById("lang-tabNotifications").value = dashboardLabels.notifications || "Notifications"; document.getElementById("lang-tabAchievements").value = dashboardLabels.achievements || "Achievements"; document.getElementById("lang-tabLeaderboard").value = dashboardLabels.leaderboard || "Leaderboard"; document.getElementById("lang-tabProfile").value = dashboardLabels.profile || "My Profile"; document.getElementById("lang-tabPayments").value = dashboardLabels.payments || "Payment History"; 
            }
            window.deleteData = function(t, logDetails={}) { if(confirm("আপনি কি নিশ্চিতভাবে এটি মুছতে চান?")){ logAdminActivity(`Data Deleted from ${t}`, logDetails); database.ref(t).remove().catch((t => alert("Error: " + t.message))); } }
            function openModal(t, e, n) { if(n) { document.getElementById(n).reset(); } document.getElementById(t + "Title").textContent = e; document.getElementById(t).style.display = "flex" }
            window.closeModal = function(t) { document.getElementById(t).style.display = "none" }
            window.openUserModal = function() { openModal("userModal", "নতুন ব্যবহারকারী", "userForm"), document.getElementById("userId").value = "" }
            window.openCourseModal = function() { 
                const categorySelect = document.getElementById('courseCategory');
                categorySelect.innerHTML = '<option value="">ক্যাটাগরি নির্বাচন করুন</option>';
                for(const catId in allCategories) {
                    categorySelect.innerHTML += `<option value="${allCategories[catId].name}">${allCategories[catId].name}</option>`;
                }
                openModal("courseModal", "নতুন কোর্স", "courseForm"), document.getElementById("courseId").value = "";
            }
            window.editCourse = function(t) { 
                const e = allCourses[t]; 
                if (e) {
                    const categorySelect = document.getElementById('courseCategory');
                    categorySelect.innerHTML = '<option value="">ক্যাটাগরি নির্বাচন করুন</option>';
                    for(const catId in allCategories) {
                        categorySelect.innerHTML += `<option value="${allCategories[catId].name}" ${allCategories[catId].name === e.category ? 'selected' : ''}>${allCategories[catId].name}</option>`;
                    }
                    document.getElementById("courseId").value = t;
                    document.getElementById("courseName").value = e.name; 
                    document.getElementById("coursePrice").value = e.price;
                    document.getElementById("courseOrder").value = e.order || 0; // NEW: Populating order
                    document.getElementById("courseImageURL").value = e.imageURL || ""; 
                    document.getElementById("courseWhatsappLink").value = e.whatsappLink || "";
                    document.getElementById("courseTrailerURL").value = e.trailerUrl || "";
                    document.getElementById("coursePassMark").value = e.passMark || 50;
                    document.getElementById("courseDescription").value = e.description || ""; 
                    document.getElementById("courseStatus").value = e.status; 
                    document.getElementById("courseHomeworkReward").value = e.homeworkReward || 0; 
                    document.getElementById("courseHomeworkLimit").value = e.homeworkLimit || 0; 
                    openModal("courseModal", "কোর্স সম্পাদনা করুন", "courseForm");
                }
            }
            window.openProjectModal = function() { openModal("projectModal", "নতুন প্রজেক্ট", "projectForm"), document.getElementById("projectId").value = "" }
            window.editProject = function(t) { const e = allProjects[t]; e && (document.getElementById("projectId").value = t, document.getElementById("projectTitle").value = e.title, document.getElementById("projectLink").value = e.link, openModal("projectModal", "প্রজেক্ট সম্পাদনা করুন", "projectForm")) }
            window.openFooterLinkModal = function() { openModal("footerLinkModal", "নতুন ফুটার লিংক", "footerLinkForm"), document.getElementById("footerLinkId").value = "" }
            window.editFooterLink = function(t) { const e = allFooterLinks[t]; e && (document.getElementById("footerLinkId").value = t, document.getElementById("footerLinkName").value = e.name, document.getElementById("footerLinkUrl").value = e.url, openModal("footerLinkModal", "ফুটার লিংক সম্পাদনা করুন", "footerLinkForm")) }
            window.openBlogModal = function() { openModal("blogModal", "নতুন ব্লগ পোস্ট", "blogForm"), document.getElementById("blogId").value = "" }
            window.editBlogPost = function(t) { const e = allBlogPosts[t]; e && (document.getElementById("blogId").value = t, document.getElementById("blogTitle").value = e.title, document.getElementById("blogImageUrl").value = e.imageUrl || "", document.getElementById("blogContent").value = e.content, document.getElementById("blogStatus").value = e.status, openModal("blogModal", "ব্লগ পোস্ট সম্পাদনা করুন", "blogForm")) }
            window.openMenuModal = function() { openModal("menuModal", "নতুন মেনু আইটেম", "menuForm"), document.getElementById("menuId").value = "" }
            window.editMenu = function(t) { const e = allMenus[t]; e && (document.getElementById("menuId").value = t, document.getElementById("menuName").value = e.name, document.getElementById("menuUrl").value = e.url, document.getElementById("menuOrder").value = e.order, openModal("menuModal", "মেনু সম্পাদনা করুন", "menuForm")) }
            window.openRoleModal = function() { openModal("roleModal", "নতুন সাব-অ্যাডমিন রোল", "roleForm"), document.getElementById("roleId").value = "" }
            
            // NEW: Updated editRole to handle permissions
            window.editRole = function(t) { 
                const e = allRoles[t]; 
                if (e) {
                    document.getElementById("roleId").value = t;
                    document.getElementById("roleName").value = e.name;
                    document.getElementById("roleValue").value = e.value;
                    // Reset all checkboxes first
                    document.querySelectorAll('.permissions-grid input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    // Set checkboxes based on saved permissions
                    if (e.permissions) {
                        for (const perm in e.permissions) {
                            const checkbox = document.getElementById(`perm-${perm}`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        }
                    }
                    openModal("roleModal", "রোল সম্পাদনা করুন", "roleForm");
                }
            }

            window.openFeatureModal = function() { openModal("featureModal", "নতুন ফিচার", "featureForm"), document.getElementById("featureId").value = "" }
            window.editFeature = function(t) { const e = allFeatures[t]; e && (document.getElementById("featureId").value = t, document.getElementById("featureImage").value = e.image, document.getElementById("featureTitle").value = e.title, document.getElementById("featureDesc").value = e.desc, openModal("featureModal", "ফিচার সম্পাদনা করুন", "featureForm")) }
            window.updateTicketStatus = function(ticketId, status) { database.ref(`supportTickets/${ticketId}`).update({ status: status }); }
            window.openCourseContentModal = function(courseId) { currentEditingCourseId = courseId; const course = allCourses[courseId]; document.getElementById('courseContentModalTitle').innerText = `Manage Content for: ${course.name}`; renderModules(courseId); document.getElementById('courseContentModal').style.display = 'flex'; }
            function renderModules(courseId) {
                const course = allCourses[courseId];
                const container = document.getElementById('modulesContainer');
                container.innerHTML = '';
                if (course.modules) {
                    for (const moduleId in course.modules) {
                        const module = course.modules[moduleId];
                        let lessonsHtml = '';
                        if (module.lessons) {
                            for (const lessonId in module.lessons) {
                                const lesson = module.lessons[lessonId];
                                lessonsHtml += `<div class="lesson">${lesson.title} - <i>(${lesson.type})</i><button onclick="deleteLesson('${courseId}', '${moduleId}', '${lessonId}')" class="delete-btn" style="float:right;">X</button></div>`;
                            }
                        }
                        container.innerHTML += `<div class="module"><div class="module-header"><span>${module.title}</span> <div><button class="action-btn edit-btn" onclick="openQuizModalForCourse('${courseId}')">Manage Quiz</button><button onclick="deleteData('courses/${courseId}/modules/${moduleId}')" class="delete-btn">Delete Module</button></div></div>${lessonsHtml}<form class="add-lesson-form" data-module-id="${moduleId}" style="margin-top:10px;"><input type="text" placeholder="Lesson Title" required><select required><option value="video">Video</option><option value="text">Text</option></select><input type="text" placeholder="Content (e.g., YouTube URL)" required><button type="submit" class="add-new-btn" style="margin: 5px 0 0 0;">Add Lesson</button></form></div>`;
                    }
                }
                document.querySelectorAll('.add-lesson-form').forEach(form => form.addEventListener('submit', addLesson));
            }
            function addLesson(e) { e.preventDefault(); const moduleId = e.target.dataset.moduleId; const lessonData = { title: e.target.children[0].value, type: e.target.children[1].value, content: e.target.children[2].value }; database.ref(`courses/${currentEditingCourseId}/modules/${moduleId}/lessons`).push(lessonData).then(() => e.target.reset()); }
            window.deleteLesson = function(courseId, moduleId, lessonId) { if (confirm('Are you sure you want to delete this lesson?')) { database.ref(`courses/${courseId}/modules/${moduleId}/lessons/${lessonId}`).remove(); } }
            window.openQuizModalForCourse = function(courseId) { currentEditingCourseId = courseId; document.getElementById('quizModal').style.display = 'flex'; renderQuizQuestions(); }
            function renderQuizQuestions() { const container = document.getElementById('quizQuestionsContainer'); container.innerHTML = ''; const quizRef = database.ref(`courses/${currentEditingCourseId}/quiz`); quizRef.once('value', snapshot => { const questions = snapshot.val(); if(questions) { for(const qId in questions) { const q = questions[qId]; container.innerHTML += `<div class="module"><p><b>Q: ${q.text}</b> <button class="delete-btn" style="float:right;" onclick="deleteQuizQuestion('${qId}')">X</button></p><small>Correct Answer: Option ${q.correct}</small></div>`; } } else { container.innerHTML = '<p>No questions yet. Add one below.</p>'; } }); }
            window.deleteQuizQuestion = function(questionId) { if(confirm('Delete this question?')) { database.ref(`courses/${currentEditingCourseId}/quiz/${questionId}`).remove().then(renderQuizQuestions); } }
            window.openEnrollModal = function(userId) { const user = allUsers[userId]; document.getElementById('enrollUserId').value = userId; const select = document.getElementById('enrollCourseSelect'); select.innerHTML = '<option value="">Select a course...</option>'; for(const courseId in allCourses) { select.innerHTML += `<option value="${courseId}">${allCourses[courseId].name}</option>`; } openModal('enrollModal', `Enroll ${user.name || user.email}`, 'enrollForm'); }
            window.openCouponModal = function() { openModal('couponModal', 'নতুন কুপন যোগ করুন', 'couponForm'); }
            function renderCouponTable() { const t = document.getElementById("couponTableBody"); t.innerHTML = ""; for (const id in allCoupons) { const c = allCoupons[id]; const expiry = c.expiryDate ? new Date(c.expiryDate).toLocaleDateString("bn-BD") : 'N/A'; t.innerHTML += `<tr><td>${c.code}</td><td>${c.type}</td><td>${c.value} ${c.type === 'percentage' ? '%' : 'BDT'}</td><td>${expiry}</td><td><button class="action-btn delete-btn" onclick="deleteData('coupons/${id}')">মুছুন</button></td></tr>`; } }
            function renderSentNotificationsTable() { const t = document.getElementById("sentNotificationsTableBody"); t.innerHTML = ""; const sorted = Object.entries(allNotifications).sort((a,b) => b[1].timestamp - a[1].timestamp); for (const [id, n] of sorted) { t.innerHTML += `<tr><td class="message-col">${n.message}</td><td>${new Date(n.timestamp).toLocaleString("bn-BD")}</td><td><button class="action-btn delete-btn" onclick="deleteData('notifications/${id}')">মুছুন</button></td></tr>`; } }
            
            async function calculateAdvancedAnalytics() {
                const courseAnalytics = {};
                const now = new Date();
                const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                let monthlyRevenue = 0;
                let monthlyUsers = 0;
                
                // NEW: Advanced Analytics calculations
                let activeCount = 0;
                let pendingCount = 0;
                const countryCounts = {};

                for (const courseId in allCourses) {
                    courseAnalytics[courseId] = { name: allCourses[courseId].name, enrollments: 0, revenue: 0 };
                }

                for (const paymentId in allPayments) {
                    const payment = allPayments[paymentId];
                    if (courseAnalytics[payment.courseId]) {
                        courseAnalytics[payment.courseId].revenue += payment.amount;
                    }
                    if (new Date(payment.date) >= firstDayOfMonth) {
                        monthlyRevenue += payment.amount;
                    }
                }
                document.getElementById('monthlyEarnings').textContent = monthlyRevenue.toLocaleString('bn-BD');
                
                let referralCounts = {};
                for (const userId in allUsers) {
                    const user = allUsers[userId];
                     // NEW: Count statuses
                    if(user.status === 'active') activeCount++;
                    if(user.status === 'pending') pendingCount++;
                    // NEW: Count countries
                    if(user.countryCode) {
                        countryCounts[user.countryCode] = (countryCounts[user.countryCode] || 0) + 1;
                    }

                    if (user.enrolledCourses) {
                        for (const enrollId in user.enrolledCourses) {
                            const courseId = user.enrolledCourses[enrollId].courseId;
                            if (courseAnalytics[courseId]) {
                                courseAnalytics[courseId].enrollments++;
                            }
                        }
                    }
                    if (user.regDate && new Date(user.regDate) >= firstDayOfMonth) {
                        monthlyUsers++;
                    }
                    if (user.referredBy) {
                        referralCounts[user.referredBy] = (referralCounts[user.referredBy] || 0) + 1;
                    }
                }
                document.getElementById('monthlyNewUsers').textContent = monthlyUsers;

                // NEW: Update new analytics cards
                document.getElementById('activePendingUsers').textContent = `${activeCount} / ${pendingCount}`;
                const topCountry = Object.keys(countryCounts).length > 0 ? Object.entries(countryCounts).sort((a, b) => b[1] - a[1])[0][0] : 'N/A';
                document.getElementById('topUserCountry').textContent = topCountry;
                
                let topReferrerId = null;
                let maxReferrals = 0;
                for(const userId in referralCounts){
                    if(referralCounts[userId] > maxReferrals){
                        maxReferrals = referralCounts[userId];
                        topReferrerId = userId;
                    }
                }
                document.getElementById('topReferrer').textContent = topReferrerId && allUsers[topReferrerId] ? allUsers[topReferrerId].name : 'N/A';


                const tableBody = document.querySelector("#courseAnalyticsTable tbody");
                tableBody.innerHTML = "";
                for (const courseId in courseAnalytics) {
                    const data = courseAnalytics[courseId];
                    tableBody.innerHTML += `<tr><td>${data.name}</td><td>${data.enrollments}</td><td>${data.revenue.toLocaleString('bn-BD')}</td></tr>`;
                }

                renderMonthlyRevenueChart();

                const enrollmentCounts = {};
                Object.values(allUsers).forEach(user => { if(user.enrolledCourses) { Object.values(user.enrolledCourses).forEach(enrollment => { enrollmentCounts[enrollment.courseId] = (enrollmentCounts[enrollment.courseId] || 0) + 1; }); } }); let popularCourseId = null, maxEnrollments = 0; for(const courseId in enrollmentCounts) { if(enrollmentCounts[courseId] > maxEnrollments) { maxEnrollments = enrollmentCounts[courseId]; popularCourseId = courseId; } } document.getElementById('popularCourse').textContent = popularCourseId && allCourses[popularCourseId] ? allCourses[popularCourseId].name : 'N/A'; 
                
                let totalPercentage = 0; let enrolledUsersCount = 0;
                Object.values(allUsers).forEach(user => { if (user.enrolledCourses) { enrolledUsersCount++; Object.values(user.enrolledCourses).forEach(enrollment => { const course = allCourses[enrollment.courseId]; if (course) { const totalLessons = (course.modules ? Object.values(course.modules).reduce((acc, mod) => acc + (mod.lessons ? Object.keys(mod.lessons).length : 0), 0) : 0); const completedLessons = enrollment.progress ? Object.keys(enrollment.progress).length : 0; const progressPercentage = totalLessons > 0 ? (completedLessons / totalLessons) * 100 : 0; totalPercentage += progressPercentage; } }); } }); 
                const avgCompletion = enrolledUsersCount > 0 ? Math.round(totalPercentage / Object.keys(allCourses).length / enrolledUsersCount) : 0; 
                document.getElementById('completionRate').textContent = `${avgCompletion}%`; 
                document.getElementById('avgCompletionRateAnalytics').textContent = `${avgCompletion}%`;
            }

            function renderMonthlyRevenueChart() {
                const monthlyData = {};
                for (let i = 5; i >= 0; i--) {
                    const d = new Date();
                    d.setMonth(d.getMonth() - i);
                    const monthKey = `${d.getFullYear()}-${d.getMonth()}`;
                    monthlyData[monthKey] = { label: d.toLocaleString('default', { month: 'short' }), revenue: 0 };
                }

                Object.values(allPayments).forEach(payment => {
                    if (payment.date) {
                        const paymentDate = new Date(payment.date);
                        const monthKey = `${paymentDate.getFullYear()}-${paymentDate.getMonth()}`;
                        if (monthlyData[monthKey]) {
                            monthlyData[monthKey].revenue += payment.amount;
                        }
                    }
                });

                const labels = Object.values(monthlyData).map(m => m.label);
                const data = Object.values(monthlyData).map(m => m.revenue);
                const ctx = document.getElementById('monthlyRevenueChart').getContext('2d');
                if (monthlyRevenueChartInstance) {
                    monthlyRevenueChartInstance.destroy();
                }
                monthlyRevenueChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Monthly Revenue (BDT)',
                            data: data,
                            backgroundColor: 'rgba(243, 156, 18, 0.6)',
                            borderColor: 'rgba(243, 156, 18, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }


            function populateCourseSelect() {
                const select = document.getElementById('groupNotificationCourse');
                select.innerHTML = '<option value="">একটি কোর্স নির্বাচন করুন...</option>';
                for (const courseId in allCourses) {
                    select.innerHTML += `<option value="${courseId}">${allCourses[courseId].name}</option>`;
                }
            }
            
            async function handleGroupNotification(event) {
                event.preventDefault();
                const courseId = document.getElementById('groupNotificationCourse').value;
                const message = document.getElementById('groupNotificationMessage').value;
                if (!courseId || !message.trim()) {
                    alert('অনুগ্রহ করে কোর্স এবং বার্তা দিন।');
                    return;
                }

                const userIdsToSend = [];
                for (const userId in allUsers) {
                    const user = allUsers[userId];
                    if (user.enrolledCourses) {
                        const isEnrolled = Object.values(user.enrolledCourses).some(enroll => enroll.courseId === courseId);
                        if (isEnrolled) {
                            userIdsToSend.push(userId);
                        }
                    }
                }

                if (userIdsToSend.length > 0) {
                    alert(`${userIdsToSend.length} জন শিক্ষার্থীকে বিজ্ঞপ্তি পাঠানো হচ্ছে...`);
                    const notificationPromises = userIdsToSend.map(userId => {
                        return database.ref('notifications').push({
                            message: `[${allCourses[courseId].name}]: ${message}`,
                            timestamp: new Date().getTime(),
                            userId: userId
                        });
                    });
                    await Promise.all(notificationPromises);
                    logAdminActivity('Group Notification Sent', { courseId: courseId, studentCount: userIdsToSend.length });
                    alert(`${userIdsToSend.length} জন শিক্ষার্থীকে সফলভাবে বিজ্ঞপ্তি পাঠানো হয়েছে।`);
                    event.target.reset();
                } else {
                    alert('এই কোর্সে কোনো শিক্ষার্থী পাওয়া যায়নি।');
                }
            }
            
            window.openBadgeModal = function(badgeId = null) {
                document.getElementById('badgeForm').reset();
                document.getElementById('badgeId').value = badgeId || '';
                if (badgeId) {
                    database.ref(`siteContent/gamificationSettings/badges/${badgeId}`).once('value', snapshot => {
                        const badge = snapshot.val();
                        document.getElementById('badgeName').value = badge.name;
                        document.getElementById('badgeIcon').value = badge.icon;
                        document.getElementById('badgeType').value = badge.type;
                        document.getElementById('badgeValue').value = badge.value;
                    });
                }
                openModal('badgeModal', badgeId ? 'ব্যাজ সম্পাদনা করুন' : 'নতুন ব্যাজ', 'badgeForm');
            }

            function renderBadgesTable(badges) {
                const tbody = document.getElementById('badgesTableBody');
                tbody.innerHTML = '';
                for (const id in badges) {
                    const badge = badges[id];
                    tbody.innerHTML += `<tr>
                        <td>${badge.name}</td>
                        <td><i class="${badge.icon}"></i> (${badge.icon})</td>
                        <td>${badge.type.replace('_', ' ')}: ${badge.value}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="openBadgeModal('${id}')">সম্পাদনা</button>
                            <button class="action-btn delete-btn" onclick="deleteData('siteContent/gamificationSettings/badges/${id}')">মুছুন</button>
                        </td>
                    </tr>`;
                }
            }

            window.generateCertificatePreview = function(userName, courseName) {
                alert(`সার্টিফিকেট প্রিভিউ:\n\nপ্রাপক: ${userName}\nকোর্স: ${courseName}\n\n(একটি পূর্ণাঙ্গ সার্টিফিকেট জেনারেটর এখানে যুক্ত করা যেতে পারে)`);
            }
            
            // FIXED: activateUser function made global and corrected a variable name
            window.activateUser = async function(userIdToActivate) {
                if (!confirm("Are you sure you want to activate this user? This will add bonuses to the user and their referrer.")) return;
                const userRef = database.ref('users/' + userIdToActivate);
                const settingsSnap = await database.ref('siteContent/referralSettings').once('value');
                const referralSettings = settingsSnap.val() || { newUserBonus: 400, referrerBonus: 160, mentorReferrerBonus: 50 };

                userRef.once('value').then(snapshot => {
                    const userToActivate = snapshot.val();
                    if (!userToActivate) { alert("User not found!"); return; }

                    userRef.update({ status: 'active', balance: referralSettings.newUserBonus }).then(() => {
                        logAdminActivity('User Activated', {userId: userIdToActivate, email: userToActivate.email, bonus: referralSettings.newUserBonus});

                        if (userToActivate.referredBy) {
                            const referrerRef = database.ref('users/' + userToActivate.referredBy);
                            referrerRef.once('value', referrerSnapshot => {
                                const referrer = referrerSnapshot.val();
                                if (!referrer) return;

                                const mentorRoles = ['Senior Team Leader', 'Team Leader', 'Trainer'];
                                // Corrected variable name from referrerRoles to mentorRoles
                                let bonusAmount = mentorRoles.includes(referrer.role) ? referralSettings.mentorReferrerBonus : referralSettings.referrerBonus;
                                
                                referrerRef.child('balance').transaction(currentBalance => {
                                    return (currentBalance || 0) + bonusAmount;
                                }).then(() => {
                                    alert(`User activated successfully! New user got ${referralSettings.newUserBonus} BDT, referrer got ${bonusAmount} BDT.`);
                                });
                            });
                        } else {
                            alert(`User activated successfully with ${referralSettings.newUserBonus} BDT bonus! (No referrer found).`);
                        }
                    });
                });
            }
            
            function renderHomeworkReviewTable(homeworksToRender) {
                const tbody = document.getElementById("homeworkReviewTableBody");
                tbody.innerHTML = "";
                if (Object.keys(homeworksToRender).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">No homework submissions found for this page.</td></tr>';
                    return;
                }

                for(const id in homeworksToRender) {
                    const sub = homeworksToRender[id];
                    const user = allUsers[sub.userId];
                    const actionButtons = sub.status === 'submitted' ? `
                        <button class="action-btn" style="background-color: var(--success-color);" onclick="approveHomework('${id}')">Approve</button>
                        <button class="action-btn" style="background-color: var(--danger-color);" onclick="rejectHomework('${id}')">Reject</button>
                        <button class="action-btn" style="background-color: var(--primary-color);" onclick="requestCorrection('${id}')">Correction</button>
                    ` : '(Reviewed)';
                    tbody.innerHTML += `<tr>
                        <td>${user ? user.name : 'Unknown User'}</td>
                        <td>${sub.courseName}</td>
                        <td><a href="${sub.homeworkLink}" target="_blank">View Work</a></td>
                        <td>${new Date(sub.submittedAt).toLocaleString()}</td>
                        <td><span class="status ${sub.status}">${sub.status.replace('_',' ')}</span></td>
                        <td>${actionButtons}</td>
                    </tr>`;
                }
            }

            window.approveHomework = function(submissionId) {
                const submission = allHomework[submissionId];
                if (!submission) return;
                
                const updates = {};
                updates[`homeworkSubmissions/${submissionId}/status`] = 'approved';
                updates[`homeworkSubmissions/${submissionId}/reviewedAt`] = new Date().toISOString();

                database.ref().update(updates).then(() => {
                    const userBalanceRef = database.ref(`users/${submission.userId}/balance`);
                    userBalanceRef.transaction(currentBalance => {
                        return (currentBalance || 0) + (submission.rewardAmount || 0);
                    }).then(() => alert('Homework approved and reward has been added to user balance.'));
                });
            }

            window.rejectHomework = function(submissionId) {
                const reason = prompt("Please provide the reason for rejection:");
                if (reason && reason.trim()) {
                     database.ref(`homeworkSubmissions/${submissionId}`).update({ 
                        status: 'rejected', 
                        adminNotes: reason,
                        reviewedAt: new Date().toISOString() 
                    }).then(() => alert('Homework rejected.'));
                }
            }
            
            window.requestCorrection = function(submissionId) {
                const reason = prompt("Please provide the reason for correction:");
                if (reason && reason.trim()) {
                    database.ref(`homeworkSubmissions/${submissionId}`).update({ 
                        status: 'correction_needed', 
                        adminNotes: reason,
                        reviewedAt: new Date().toISOString() 
                    }).then(() => alert('Homework sent back for correction.'));
                }
            }
            
            function renderWithdrawalRequestsTable() {
                const tbody = document.getElementById("withdrawalRequestsTableBody");
                tbody.innerHTML = "";
                const requests = Object.entries(allWithdrawals).sort((a,b) => new Date(b[1].requestedAt) - new Date(a[1].requestedAt));
                if (requests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">No withdrawal requests found.</td></tr>';
                    return;
                }
                requests.forEach(([id, req]) => {
                    tbody.innerHTML += `<tr>
                        <td>${req.userName}</td>
                        <td>${req.amount.toLocaleString('bn-BD')}</td>
                        <td>${req.method}</td>
                        <td>${req.accountDetails}</td>
                        <td>${new Date(req.requestedAt).toLocaleString()}</td>
                        <td><span class="status ${req.status}">${req.status}</span></td>
                        <td>
                            ${req.status === 'pending' ? `
                            <button class="action-btn" style="background-color: var(--success-color);" onclick="processWithdrawal('${id}')">Processed</button>
                            <button class="action-btn" style="background-color: var(--danger-color);" onclick="rejectWithdrawal('${id}')">Reject</button>
                            ` : `(Completed)`}
                        </td>
                    </tr>`;
                });
            }
            
            window.processWithdrawal = function(requestId) {
                if (!confirm("গুরুত্বপূর্ণ: আপনি কি ব্যবহারকারীকে ম্যানুয়ালি টাকা পাঠিয়েছেন? এই কাজটি তার অ্যাকাউন্ট থেকে ব্যালেন্স কেটে নেবে এবং এটি আর ফেরানো যাবে না।")) return;
                
                const request = allWithdrawals[requestId];
                if (!request) return;

                const userBalanceRef = database.ref(`users/${request.userId}/balance`);
                userBalanceRef.transaction(currentBalance => {
                    if ((currentBalance || 0) < request.amount) {
                        return; 
                    }
                    return currentBalance - request.amount;
                }).then(result => {
                    if (!result.committed) {
                        alert("Transaction failed! The user might not have enough balance.");
                    } else {
                        database.ref(`withdrawalRequests/${requestId}`).update({ status: 'processed' });
                        logAdminActivity('Withdrawal Processed', {requestId, userId: request.userId, amount: request.amount});
                        alert("Withdrawal marked as processed and balance deducted.");
                    }
                });
            }
            
            window.rejectWithdrawal = function(requestId) {
                 if (!confirm("Are you sure you want to reject this request?")) return;
                 database.ref(`withdrawalRequests/${requestId}`).update({ status: 'rejected' })
                 .then(() => {
                    logAdminActivity('Withdrawal Rejected', {requestId});
                    alert('Request has been rejected.');
                });
            }

            window.viewUserProgress = function(userId) {
                const user = allUsers[userId];
                if (!user) { alert('User not found!'); return; }
                
                const container = document.getElementById('userProgressContainer');
                container.innerHTML = '';
                
                if (!user.enrolledCourses) {
                    container.innerHTML = '<p>This user has not enrolled in any courses yet.</p>';
                } else {
                    let html = '';
                    for (const enrollId in user.enrolledCourses) {
                        const enrollment = user.enrolledCourses[enrollId];
                        const course = allCourses[enrollment.courseId];
                        if (course) {
                            const totalLessons = (course.modules ? Object.values(course.modules).reduce((acc, mod) => acc + (mod.lessons ? Object.keys(mod.lessons).length : 0), 0) : 0);
                            const completedLessons = enrollment.progress ? Object.keys(enrollment.progress).length : 0;
                            const progressPercentage = totalLessons > 0 ? Math.round((completedLessons / totalLessons) * 100) : 0;
                            html += `
                                <div class="module">
                                    <h4>${course.name}</h4>
                                    <p>Progress: ${completedLessons} / ${totalLessons} lessons completed (${progressPercentage}%)</p>
                                    <div style="background: #eee; border-radius: 5px; height: 20px; overflow: hidden;">
                                        <div style="width: ${progressPercentage}%; background: var(--success-color); height: 100%;"></div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    container.innerHTML = html;
                }
                openModal('userProgressModal', `Progress for ${user.name}`, null);
            }

            window.replyToTicket = function(ticketId) {
                const reply = prompt("Enter your reply to the user:");
                if (reply && reply.trim() !== '') {
                    database.ref(`supportTickets/${ticketId}`).update({
                        reply: reply,
                        status: 'resolved'
                    }).then(() => alert('Reply sent and ticket marked as resolved.'));
                }
            }
            
            function renderMentorRoleSettings() {
                const container = document.getElementById('mentorRolesContainer');
                container.innerHTML = '';
                database.ref('siteContent/settings/mentorRoles').once('value', snapshot => {
                    const selectedRoles = snapshot.val() || [];
                    for (const roleId in allRoles) {
                        const role = allRoles[roleId];
                        const isChecked = selectedRoles.includes(role.name);
                        container.innerHTML += `
                            <div>
                                <input type="checkbox" id="role_${roleId}" value="${role.name}" ${isChecked ? 'checked' : ''}>
                                <label for="role_${roleId}">${role.name}</label>
                            </div>
                        `;
                    }
                });
            }
            
            function handleMentorRoleSave(event) {
                event.preventDefault();
                const selectedRoles = [];
                const checkboxes = document.querySelectorAll('#mentorRolesContainer input[type="checkbox"]:checked');
                checkboxes.forEach(cb => selectedRoles.push(cb.value));
                
                database.ref('siteContent/settings/mentorRoles').set(selectedRoles)
                    .then(() => alert('মেন্টর রোল সফলভাবে সেভ করা হয়েছে!'))
                    .catch(err => alert('ত্রুটি: ' + err.message));
            }

            function renderLiveClassTable() {
                const tbody = document.getElementById('liveClassTableBody');
                tbody.innerHTML = '';
                const sortedClasses = Object.entries(allLiveClasses).sort((a,b) => new Date(b[1].dateTime) - new Date(a[1].dateTime));
                for (const [id, cls] of sortedClasses) {
                    const recordingLink = cls.recordingUrl ? `<a href="${cls.recordingUrl}" target="_blank">View</a>` : 'N/A';
                    tbody.innerHTML += `<tr>
                        <td>${cls.title}</td>
                        <td>${cls.teacher || 'N/A'}</td>
                        <td><a href="${cls.url}" target="_blank">Join Link</a></td>
                        <td>${new Date(cls.dateTime).toLocaleString('bn-BD')}</td>
                        <td>${recordingLink}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="addRecordingToLiveClass('${id}')">Recording</button>
                            <button class="action-btn delete-btn" onclick="deleteData('liveClasses/${id}')">মুছুন</button>
                        </td>
                    </tr>`;
                }
            }

            window.addRecordingToLiveClass = function(classId) {
                const url = prompt("Enter the recording URL for this class:");
                if (url) {
                    database.ref(`liveClasses/${classId}`).update({ recordingUrl: url })
                        .then(() => alert("Recording link added successfully."));
                }
            }

            function renderForumPostsTable(posts) {
                const tbody = document.getElementById('forumPostsTableBody');
                tbody.innerHTML = '';
                const sorted = Object.entries(posts).sort((a,b) => {
                    if (a[1].pinned && !b[1].pinned) return -1;
                    if (!a[1].pinned && b[1].pinned) return 1;
                    return new Date(b[1].timestamp) - new Date(a[1].timestamp);
                });
                sorted.forEach(([id, post]) => {
                    const postContent = post.pinned ? `<strong>[PINNED]</strong> ${post.content}` : post.content;
                    const adminReply = post.adminReply ? `<br><br><div style="border-left: 3px solid #3498db; padding-left: 10px; font-style: italic;"><strong>Admin Reply:</strong> ${post.adminReply}</div>` : '';
                    tbody.innerHTML += `<tr>
                        <td>${post.authorName}</td>
                        <td class="message-col">${postContent} ${adminReply}</td>
                        <td>${new Date(post.timestamp).toLocaleString()}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editForumPost('${id}', \`${post.content}\`)">Edit</button>
                            <button class="action-btn" style="background-color: #f39c12;" onclick="togglePinPost('${id}', ${post.pinned || false})">${post.pinned ? 'Unpin' : 'Pin'}</button>
                            <button class="action-btn" style="background-color: #16a085;" onclick="replyToForumPost('${id}')">Reply</button>
                            <button class="action-btn delete-btn" onclick="deleteData('forum_posts/${id}')">মুছুন</button>
                        </td>
                    </tr>`;
                });
            }

            window.editForumPost = function(postId, currentContent) {
                const newContent = prompt("Edit the post content:", currentContent);
                if (newContent && newContent.trim() !== "") {
                    database.ref(`forum_posts/${postId}`).update({ content: newContent });
                }
            }

            window.togglePinPost = function(postId, isPinned) {
                database.ref(`forum_posts/${postId}`).update({ pinned: !isPinned });
            }

            window.replyToForumPost = function(postId) {
                const reply = prompt("Enter your reply as Admin:");
                if (reply && reply.trim() !== "") {
                    database.ref(`forum_posts/${postId}`).update({ adminReply: reply });
                }
            }

            function renderCategoryTable() {
                const tbody = document.getElementById('categoryTableBody');
                tbody.innerHTML = '';
                for(const id in allCategories) {
                    const category = allCategories[id];
                    tbody.innerHTML += `<tr>
                        <td>${category.name}</td>
                        <td>
                            <button class="action-btn edit-btn" onclick="editCategory('${id}')">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteData('courseCategories/${id}')">Delete</button>
                        </td>
                    </tr>`;
                }
            }

            window.openCategoryModal = function() {
                openModal('categoryModal', 'নতুন ক্যাটাগরি', 'categoryForm');
                document.getElementById('categoryId').value = '';
            }

            window.editCategory = function(id) {
                const category = allCategories[id];
                document.getElementById('categoryId').value = id;
                document.getElementById('categoryName').value = category.name;
                openModal('categoryModal', 'ক্যাটাগরি সম্পাদনা করুন', null);
            }

            function handleCategoryForm(event) {
                event.preventDefault();
                const id = document.getElementById('categoryId').value;
                const name = document.getElementById('categoryName').value;
                if (!name) return;

                const data = { name: name };
                const ref = id ? database.ref(`courseCategories/${id}`) : database.ref('courseCategories').push();
                ref.set(data).then(() => {
                    closeModal('categoryModal');
                });
            }
            
            function applyBulkAction() {
                const action = document.getElementById('bulkActionSelect').value;
                const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
                if (!action || selectedCheckboxes.length === 0) {
                    alert('অনুগ্রহ করে একটি অ্যাকশন এবং অন্তত একজন ব্যবহারকারী নির্বাচন করুন।');
                    return;
                }
                
                const userIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.userId);
                const confirmationText = `আপনি কি নিশ্চিত যে আপনি ${userIds.length} জন ব্যবহারকারীর উপর "${action}" অ্যাকশন প্রয়োগ করতে চান?`;

                if (!confirm(confirmationText)) return;

                const promises = userIds.map(userId => {
                    const userRef = database.ref('users/' + userId);
                    switch (action) {
                        case 'activate':
                            return userRef.update({ status: 'active' });
                        case 'block':
                            return userRef.update({ status: 'blocked' });
                        case 'delete':
                            return userRef.remove();
                        default:
                            return Promise.resolve();
                    }
                });

                Promise.all(promises)
                    .then(() => {
                        logAdminActivity(`Bulk Action: ${action}`, { userCount: userIds.length });
                        alert('বাল্ক অ্যাকশন সফলভাবে সম্পন্ন হয়েছে!');
                        document.getElementById('selectAllUsersCheckbox').checked = false;
                    })
                    .catch(err => {
                        alert('একটি ত্রুটি ঘটেছে: ' + err.message);
                    });
            }

            window.updateTicketPriority = function(ticketId, priority) {
                database.ref(`supportTickets/${ticketId}`).update({ priority: priority })
                    .then(() => console.log(`Ticket ${ticketId} priority updated to ${priority}`))
                    .catch(err => alert('Failed to update priority: ' + err.message));
            }

            window.assignTicket = function(ticketId, assigneeEmail) {
                database.ref(`supportTickets/${ticketId}`).update({ assignedTo: assigneeEmail })
                    .then(() => console.log(`Ticket ${ticketId} assigned to ${assigneeEmail}`))
                    .catch(err => alert('Failed to assign ticket: ' + err.message));
            }
            
            function renderReferralAndMentorTables() {
                const referralTbody = document.getElementById('referralTableBody');
                const mentorTbody = document.getElementById('mentorPerformanceTableBody');
                referralTbody.innerHTML = '';
                mentorTbody.innerHTML = '';

                const userList = Object.entries(allUsers);
                const mentorStats = {};

                userList.forEach(([userId, user]) => {
                    if (user.referredBy && allUsers[user.referredBy]) {
                        const referrer = allUsers[user.referredBy];
                        referralTbody.innerHTML += `
                            <tr>
                                <td>${referrer.name || 'N/A'}</td>
                                <td>${user.name || 'N/A'}</td>
                                <td><span class="status ${user.status}">${user.status}</span></td>
                                <td>${new Date(user.regDate).toLocaleDateString('bn-BD')}</td>
                            </tr>`;

                        if (referrer.role) {
                             if (!mentorStats[user.referredBy]) {
                                mentorStats[user.referredBy] = { id: user.referredBy, name: referrer.name, role: referrer.role, leads: 0, converts: 0 };
                            }
                            if (user.status === 'pending') {
                                mentorStats[user.referredBy].leads++;
                            } else if (user.status === 'active') {
                                mentorStats[user.referredBy].converts++;
                            }
                        }
                    }
                });

                if (referralTbody.innerHTML === '') {
                    referralTbody.innerHTML = '<tr><td colspan="4">কোনো রেফারেল ডেটা পাওয়া যায়নি।</td></tr>';
                }

                for (const mentorId in mentorStats) {
                    const stats = mentorStats[mentorId];
                    mentorTbody.innerHTML += `
                        <tr>
                            <td>${stats.name}</td>
                            <td>${stats.role}</td>
                            <td>${stats.leads}</td>
                            <td>${stats.converts}</td>
                            <td>
                                <button class="action-btn edit-btn" onclick="viewMentorLeads('${stats.id}')">লিড দেখুন</button>
                            </td>
                        </tr>`;
                }

                if (mentorTbody.innerHTML === '') {
                    mentorTbody.innerHTML = '<tr><td colspan="5">কোনো মেন্টর পারফরম্যান্স ডেটা পাওয়া যায়নি।</td></tr>';
                }
            }

            window.viewMentorLeads = function(mentorId) {
                const mentor = allUsers[mentorId];
                if (!mentor) return;

                const container = document.getElementById('mentorLeadsContainer');
                let tableHtml = `<h4>${mentor.name} এর লিডসমূহ</h4>`;
                tableHtml += `<table style="width: 100%"><thead><tr><th>নাম</th><th>হোয়াটসঅ্যাপ</th></tr></thead><tbody>`;
                
                let leadsFound = false;
                for (const userId in allUsers) {
                    const user = allUsers[userId];
                    if (user.referredBy === mentorId && user.status === 'pending') {
                        leadsFound = true;
                        const whatsappLink = user.whatsapp 
                            ? `<a href="https://wa.me/${(user.countryCode || '' ) + user.whatsapp}" target="_blank" class="action-btn enroll-btn">Message</a>` 
                            : 'N/A';
                        tableHtml += `<tr><td>${user.name || 'N/A'}</td><td>${whatsappLink}</td></tr>`;
                    }
                }

                if (!leadsFound) {
                    tableHtml += `<tr><td colspan="2">এই মেন্টরের কোনো পেন্ডিং লিড নেই।</td></tr>`;
                }
                
                tableHtml += `</tbody></table>`;
                container.innerHTML = tableHtml;
                openModal('mentorLeadsModal', `মেন্টরের লিডসমূহ`, null);
            }
            
            function renderBalanceLogsTable() {
                const tbody = document.getElementById('balanceLogsTableBody');
                tbody.innerHTML = '';
                
                const sortedLogs = Object.values(allBalanceLogs).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                if (sortedLogs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">কোনো ব্যালেন্স পরিবর্তনের লগ পাওয়া যায়নি।</td></tr>';
                    return;
                }

                sortedLogs.forEach(log => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${new Date(log.timestamp).toLocaleString('bn-BD')}</td>
                            <td>${log.userName || 'N/A'} (${log.userId.substring(0, 8)}...)</td>
                            <td>${log.adminEmail || 'N/A'}</td>
                            <td>${(log.oldBalance || 0).toLocaleString('bn-BD')}</td>
                            <td>${(log.newBalance || 0).toLocaleString('bn-BD')}</td>
                            <td class="message-col">${log.reason}</td>
                        </tr>
                    `;
                });
            }

            function renderCountryCodeTable() {
                const tbody = document.getElementById('countryCodeTableBody');
                tbody.innerHTML = '';
                for(const id in allCountryCodes) {
                    const country = allCountryCodes[id];
                    tbody.innerHTML += `<tr><td>${country.name}</td><td>${country.code}</td><td><button class="action-btn edit-btn" onclick="editCountryCode('${id}')">Edit</button><button class="action-btn delete-btn" onclick="deleteData('countryCodes/${id}')">Delete</button></td></tr>`;
                }
            }
            window.openCountryCodeModal = function() { openModal('countryCodeModal', 'নতুন কান্ট্রি কোড', 'countryCodeForm'); document.getElementById('countryCodeId').value = ''; }
            window.editCountryCode = function(id) { const country = allCountryCodes[id]; document.getElementById('countryCodeId').value = id; document.getElementById('countryName').value = country.name; document.getElementById('countryCodeValue').value = country.code; openModal('countryCodeModal', 'কান্ট্রি কোড সম্পাদনা করুন', null); }
            function handleCountryCodeForm(e) { e.preventDefault(); const id = document.getElementById('countryCodeId').value; const name = document.getElementById('countryName').value; const code = document.getElementById('countryCodeValue').value; if (!name || !code) return; const data = { name, code }; const ref = id ? database.ref(`countryCodes/${id}`) : database.ref('countryCodes').push(); ref.set(data).then(() => closeModal('countryCodeModal')); }
            
            function renderActivityLogTable() {
                const tbody = document.getElementById('activityLogsTableBody');
                tbody.innerHTML = '';
                const sortedLogs = Object.values(allActivityLogs).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                sortedLogs.slice(0, 100).forEach(log => { // Show latest 100 logs
                    tbody.innerHTML += `<tr><td>${new Date(log.timestamp).toLocaleString()}</td><td>${log.adminEmail}</td><td>${log.action}</td><td>${JSON.stringify(log.details)}</td></tr>`;
                });
            }
            
            window.openManualBadgeModal = function(userId) {
                document.getElementById('manualBadgeUserId').value = userId;
                const select = document.getElementById('manualBadgeSelect');
                select.innerHTML = '<option value="">একটি ব্যাজ নির্বাচন করুন...</option>';
                database.ref('siteContent/gamificationSettings/badges').once('value', snapshot => {
                    const badges = snapshot.val();
                    for(const badgeId in badges) {
                        select.innerHTML += `<option value="${badgeId}">${badges[badgeId].name}</option>`;
                    }
                });
                openModal('manualBadgeModal', `Award Badge to ${allUsers[userId].name}`, null);
            }
            
            function handleManualBadgeAward(event) {
                event.preventDefault();
                const userId = document.getElementById('manualBadgeUserId').value;
                const badgeId = document.getElementById('manualBadgeSelect').value;
                if(!userId || !badgeId) return;

                database.ref(`siteContent/gamificationSettings/badges/${badgeId}`).once('value', snapshot => {
                    const badgeData = snapshot.val();
                    if(badgeData) {
                        database.ref(`users/${userId}/gamification/badges/${badgeId}`).set({
                            name: badgeData.name,
                            icon: badgeData.icon,
                            awardedAt: new Date().toISOString()
                        }).then(() => {
                            logAdminActivity('Manual Badge Awarded', { userId: userId, badgeName: badgeData.name });
                            alert('Badge awarded successfully!');
                            closeModal('manualBadgeModal');
                        });
                    }
                });
            }

        }
    </script>
</body>
</html>
